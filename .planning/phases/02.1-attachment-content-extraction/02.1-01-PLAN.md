---
phase: 02.1-attachment-content-extraction
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/search/attachment-fetcher.ts
  - midl-agent/src/search/attachment-fetcher.test.ts
autonomous: true

must_haves:
  truths:
    - "Attachment fetcher extracts GitHub user-attachment URLs from issue body markdown"
    - "Attachment fetcher downloads markdown/text content from extracted URLs"
    - "Fetch failures return empty string without throwing"
    - "Fetched content is cached with same TTL as search results"
  artifacts:
    - path: "midl-agent/src/search/attachment-fetcher.ts"
      provides: "AttachmentFetcher class"
      exports: ["AttachmentFetcher"]
    - path: "midl-agent/src/search/attachment-fetcher.test.ts"
      provides: "Unit tests for attachment fetching"
  key_links:
    - from: "attachment-fetcher.ts"
      to: "search-cache.ts"
      via: "Constructor DI - accepts optional SearchCache"
      pattern: "SearchCache"
---

<objective>
Create an AttachmentFetcher class that extracts GitHub user-attachment URLs from issue bodies, downloads their text content, and caches results.

Purpose: Issues often contain detailed error reports in attached markdown files (e.g., MIDL_SDK_INTEGRATION_REPORT.md). Without reading these attachments, duplicate detection misses critical context and scores ~40% instead of ~85%.
Output: Working, tested AttachmentFetcher class.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@midl-agent/src/search/search-cache.ts
@midl-agent/src/types/search-types.ts
</context>

<feature>
  <name>AttachmentFetcher</name>
  <files>midl-agent/src/search/attachment-fetcher.ts, midl-agent/src/search/attachment-fetcher.test.ts</files>
  <behavior>
    AttachmentFetcher has two public methods:

    1. `extractAttachmentUrls(body: string): string[]`
       - Finds URLs matching pattern: `https://github.com/user-attachments/...` (with .md or .txt extensions, or no extension)
       - Also matches `https://github.com/<owner>/<repo>/files/...` patterns for attached files
       - Returns array of URLs found in body text
       - Input: issue body string -> Output: string[] of attachment URLs
       - Empty/null body -> []
       - Body with no attachments -> []
       - Body with 2 attachment links -> [url1, url2]

    2. `fetchAttachmentContent(issueNumber: number, body: string): Promise<string>`
       - Extracts URLs from body, fetches each one, concatenates text content
       - Uses cache keyed by issue number to avoid re-fetching
       - On fetch failure for any URL, skip it (log warning) and continue with others
       - Timeout per fetch: 3 seconds (Promise.race pattern from 02-01)
       - Returns concatenated text content of all successfully fetched attachments
       - Empty body -> ""
       - No attachment URLs -> ""
       - All fetches fail -> "" (graceful degradation)

    Constructor DI pattern (from 01-01): accepts optional deps `{ cache?: SearchCache, fetchFn?: typeof fetch }`
    - fetchFn injection allows test mocking without network calls
    - cache reuses SearchCache with same TTL

    Cache strategy: Cache keyed as `attachment:{issueNumber}` storing fetched content string.
    Since SearchCache stores GitHubIssueResult[], we need a separate simple Map<string, string> cache
    with same TTL logic, OR store attachment content on the GitHubIssueResult type.
    Simplest: use a private Map<number, { content: string; timestamp: number }> with TTL matching SearchCache default (300_000ms).
  </behavior>
  <implementation>
    Class with:
    - Private `attachmentCache: Map<number, { content: string; timestamp: number }>`
    - Private `ttlMs: number` (default 300_000, same as SearchCache)
    - Private `fetchFn` for DI (defaults to global fetch)
    - `extractAttachmentUrls`: regex matching `https://github\.com/user-attachments/assets/[^\s)]+` and similar patterns
    - `fetchAttachmentContent`: extract URLs, check cache, fetch with Promise.race timeout, concatenate, cache result
    - Graceful degradation: try/catch around each fetch, console.warn on failure, continue
  </implementation>
</feature>

<verification>
- `npm test -- attachment-fetcher` passes
- RED: tests written first and fail
- GREEN: implementation makes them pass
- All tests use injected fetchFn mock, no real network calls
</verification>

<success_criteria>
- AttachmentFetcher extracts URLs from issue body markdown
- AttachmentFetcher fetches and concatenates attachment text content
- Fetch failures degrade gracefully (return empty string, no throw)
- Results cached with 5-minute TTL
- All behavior verified by tests
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-attachment-content-extraction/02.1-01-SUMMARY.md`
</output>
