---
phase: "02.1"
plan: "02"
subsystem: search
tags: [attachment, similarity, duplicate-detection, integration]
dependency-graph:
  requires: ["02.1-01"]
  provides: ["Attachment content integrated into duplicate detection scoring pipeline"]
  affects: ["05-integration-polish"]
tech-stack:
  added: []
  patterns: ["Constructor DI for optional AttachmentFetcher", "Optional parameter for backward compatibility"]
key-files:
  created: []
  modified:
    - midl-agent/src/search/similarity-scorer.ts
    - midl-agent/src/search/similarity-scorer.test.ts
    - midl-agent/src/search/duplicate-detector.ts
    - midl-agent/src/search/duplicate-detector.test.ts
decisions:
  - id: "02.1-02-optional-param"
    description: "attachmentContent as optional third parameter to score() for backward compatibility"
metrics:
  duration: "3 min"
  completed: "2026-02-01"
---

# Phase 2.1 Plan 02: Wire AttachmentFetcher into Scoring Pipeline Summary

**One-liner:** SimilarityScorer.score() accepts optional attachmentContent concatenated into token set; DuplicateDetector fetches attachment content via injected AttachmentFetcher before scoring, enabling issues with detailed error reports in attachments to be correctly identified as duplicates.

## What Was Done

### Task 1: Add attachmentContent parameter to SimilarityScorer.score()
- Added optional third parameter `attachmentContent?: string` to `score()`
- Concatenated into issueText before tokenization: `issue.title + body + attachmentContent`
- 3 new tests: score boost with matching content, backward compat (empty/undefined), error term boost
- **Commit:** 6061777

### Task 2: Wire AttachmentFetcher into DuplicateDetector
- Imported AttachmentFetcher and added optional `fetcher` to constructor deps
- In `detect()`, fetches attachment content for each result before scoring
- Passes `attachmentContent` to `scorer.score()` as third argument
- 4 new tests: fetcher integration, backward compat, graceful degradation, key integration test
- Key test: issue with title "timeout problem" and empty body scores < 0.75 without fetcher but >= 0.75 with attachment content
- **Commit:** 4155b67

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Optional third parameter on score() | All existing callers continue to work without changes |
| Empty string fallback for missing attachment | Tokenizer ignores empty strings, produces identical scores |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- All 132 tests pass (`npx vitest run`)
- TypeScript compiles cleanly (`npx tsc --noEmit`)
- Key integration test: brief body + detailed attachment = duplicate (score >= 0.75)
- Backward compatibility confirmed: no fetcher = identical behavior

## Next Phase Readiness

- Attachment content extraction fully integrated into duplicate detection pipeline
- Phase 2.1 objective complete: issues with detailed error reports in attachments are correctly identified as duplicates
