---
phase: "02.1"
plan: "01"
subsystem: search
tags: [attachment, fetch, cache, github, tdd]
dependency-graph:
  requires: ["02-search-duplicate-detection"]
  provides: ["AttachmentFetcher class for extracting and fetching GitHub issue attachment content"]
  affects: ["05-integration-polish"]
tech-stack:
  added: []
  patterns: ["Constructor DI with fetchFn injection", "Private Map cache with TTL", "Promise.race timeout"]
key-files:
  created:
    - midl-agent/src/search/attachment-fetcher.ts
    - midl-agent/src/search/attachment-fetcher.test.ts
  modified: []
decisions:
  - id: "02.1-01-cache"
    description: "Private Map<number, {content, timestamp}> cache instead of reusing SearchCache (which stores GitHubIssueResult[])"
metrics:
  duration: "2 min"
  completed: "2026-02-01"
---

# Phase 2.1 Plan 01: Attachment Content Extraction Summary

**One-liner:** AttachmentFetcher extracts GitHub user-attachment URLs from issue bodies, fetches text content with 3s timeout, and caches results with 5-minute TTL using constructor DI pattern.

## What Was Done

### Task 1: RED - Write failing tests (TDD)
- 15 tests covering URL extraction, content fetching, caching, timeouts, and graceful degradation
- Tests use injected mockFetch, no real network calls
- **Commit:** ef188a5

### Task 2: GREEN - Implement AttachmentFetcher
- `extractAttachmentUrls(body)`: regex extraction of `github.com/user-attachments/...` and `github.com/<owner>/<repo>/files/...` URLs
- `fetchAttachmentContent(issueNumber, body)`: fetch + concatenate + cache
- Private Map cache keyed by issue number with configurable TTL (default 5 min)
- Promise.race timeout (default 3s) per fetch
- Constructor DI: `{ fetchFn?, ttlMs?, timeoutMs? }`
- **Commit:** d555923

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Private Map cache instead of SearchCache | SearchCache stores GitHubIssueResult[], attachment content is string keyed by issue number - different shape |
| 3s per-fetch timeout | Consistent with Promise.race pattern from 02-01 |
| Constructor DI for fetchFn | Enables test mocking without network, matches project pattern |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- All 15 tests pass (`npx vitest run src/search/attachment-fetcher.test.ts`)
- TypeScript compiles cleanly (`npx tsc --noEmit`)
- No real network calls in tests

## Next Phase Readiness

- AttachmentFetcher ready for integration into DuplicateDetector/similarity scoring pipeline
- Export available from `midl-agent/src/search/attachment-fetcher.ts`
