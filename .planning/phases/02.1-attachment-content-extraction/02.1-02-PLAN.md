---
phase: 02.1-attachment-content-extraction
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - midl-agent/src/search/similarity-scorer.ts
  - midl-agent/src/search/duplicate-detector.ts
  - midl-agent/src/search/similarity-scorer.test.ts
  - midl-agent/src/search/duplicate-detector.test.ts
autonomous: true

must_haves:
  truths:
    - "SimilarityScorer includes attachment content in token set alongside title and body"
    - "DuplicateDetector fetches attachment content before scoring"
    - "Issues with detailed error reports in attachments score 85%+ similarity with matching descriptions"
    - "Missing attachment content does not break scoring (empty string fallback)"
  artifacts:
    - path: "midl-agent/src/search/similarity-scorer.ts"
      provides: "Updated score() accepting optional attachmentContent parameter"
      exports: ["SimilarityScorer"]
    - path: "midl-agent/src/search/duplicate-detector.ts"
      provides: "Updated detect() that fetches attachments before scoring"
      exports: ["DuplicateDetector"]
  key_links:
    - from: "duplicate-detector.ts"
      to: "attachment-fetcher.ts"
      via: "Constructor DI - accepts optional AttachmentFetcher"
      pattern: "AttachmentFetcher"
    - from: "similarity-scorer.ts score()"
      to: "attachment content"
      via: "New optional parameter attachmentContent?: string"
      pattern: "attachmentContent"
    - from: "duplicate-detector.ts detect()"
      to: "attachment-fetcher.ts fetchAttachmentContent()"
      via: "Calls fetcher for each issue before scoring"
      pattern: "fetchAttachmentContent"
---

<objective>
Wire AttachmentFetcher into SimilarityScorer and DuplicateDetector so attachment content is included in duplicate detection scoring.

Purpose: This is the integration that actually fixes the bug -- without this wiring, the AttachmentFetcher exists but doesn't affect duplicate detection results.
Output: Updated scorer and detector with attachment content integration and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-attachment-content-extraction/02.1-01-SUMMARY.md
@midl-agent/src/search/similarity-scorer.ts
@midl-agent/src/search/duplicate-detector.ts
@midl-agent/src/search/attachment-fetcher.ts
@midl-agent/src/types/search-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add attachmentContent parameter to SimilarityScorer.score()</name>
  <files>midl-agent/src/search/similarity-scorer.ts, midl-agent/src/search/similarity-scorer.test.ts</files>
  <action>
    Modify `SimilarityScorer.score()` to accept an optional third parameter `attachmentContent?: string`.

    When provided and non-empty, concatenate it with the issue text before tokenizing:
    ```
    const issueText = issue.title + " " + (issue.body ?? "") + " " + (attachmentContent ?? "");
    ```

    This is a one-line change to the existing issueText construction on line 16 of similarity-scorer.ts.

    The parameter is optional so all existing callers continue to work without changes.

    Add tests in similarity-scorer.test.ts:
    - Test that score with attachmentContent matching description words produces higher score than without
    - Test that empty/undefined attachmentContent produces same score as before (backward compat)
    - Test that attachment content containing key error terms (e.g., "BIP322 signing verification failed") boosts score when description mentions same error
  </action>
  <verify>
    `npm test -- similarity-scorer` passes. Existing tests still pass (no regression). New tests demonstrate score increase with attachment content.
  </verify>
  <done>
    SimilarityScorer.score() accepts optional attachmentContent and includes it in tokenization. Backward compatible -- omitting parameter gives identical scores to before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AttachmentFetcher into DuplicateDetector</name>
  <files>midl-agent/src/search/duplicate-detector.ts, midl-agent/src/search/duplicate-detector.test.ts</files>
  <action>
    1. Import AttachmentFetcher in duplicate-detector.ts.

    2. Add optional `fetcher?: AttachmentFetcher` to constructor deps interface. Store as `this.fetcher`.

    3. In `detect()`, after getting search results and before scoring loop, fetch attachment content for each issue:
    ```typescript
    for (const result of results) {
      let attachmentContent = "";
      if (this.fetcher) {
        attachmentContent = await this.fetcher.fetchAttachmentContent(
          result.issue.number,
          result.issue.body ?? ""
        );
      }
      result.similarityScore = this.scorer.score(description, result.issue, attachmentContent);
    }
    ```
    This replaces the existing scoring loop (lines 29-31).

    4. When no AttachmentFetcher is injected (default), behavior is identical to before -- `attachmentContent` is empty string, scorer ignores it.

    5. Add tests in duplicate-detector.test.ts:
    - Test that when AttachmentFetcher is injected and returns content, scores reflect attachment content
    - Test that when AttachmentFetcher is not injected, behavior is identical to before
    - Test that when AttachmentFetcher.fetchAttachmentContent throws, scoring still works (the fetcher itself handles errors, but add a safety test)
    - Key test: mock an issue where body is brief ("Xverse BIP322 issue") but attachment contains full error report. With fetcher, score should be >= 0.75 (duplicate). Without fetcher, score should be < 0.5.
  </action>
  <verify>
    `npm test -- duplicate-detector` passes. The key integration test proves that attachment content raises similarity scores above the duplicate threshold.
  </verify>
  <done>
    DuplicateDetector fetches attachment content via injected AttachmentFetcher before scoring. Issues with detailed error reports in attachments are correctly identified as duplicates. Backward compatible when no fetcher is provided.
  </done>
</task>

</tasks>

<verification>
- `npm test` passes (all tests including new ones)
- Score for issue with matching attachment content >= 0.75 (duplicate threshold)
- Score for same issue without attachment content < 0.5
- No existing tests broken (backward compatibility)
</verification>

<success_criteria>
- Attachment content is included in similarity scoring
- Issues with detailed error reports in attachments are correctly flagged as duplicates
- Fetch failures degrade gracefully (empty content, score based on title+body only)
- All existing behavior preserved when AttachmentFetcher is not injected
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-attachment-content-extraction/02.1-02-SUMMARY.md`
</output>
