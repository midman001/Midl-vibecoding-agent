---
phase: 01-github-api-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/package.json
  - midl-agent/src/types/search-types.ts
  - midl-agent/src/search/github-client.ts
  - midl-agent/src/search/github-client.test.ts
  - midl-agent/.env.example
autonomous: true

must_haves:
  truths:
    - "Agent authenticates with GitHub using a personal access token from environment config"
    - "Agent queries midl-xyz/midl-js issues endpoint and receives valid results"
    - "Agent gracefully handles rate limit exhaustion without crashing"
    - "Agent logs authentication errors clearly to the user"
    - "Agent can switch to testing mode using midman001/agent-testing repository"
  artifacts:
    - path: "midl-agent/src/search/github-client.ts"
      provides: "GitHub API client with auth, rate limiting, and repo switching"
      exports: ["GitHubClient"]
    - path: "midl-agent/src/types/search-types.ts"
      provides: "TypeScript types for GitHub issue search"
      exports: ["GitHubIssueResult", "GitHubClientConfig"]
    - path: "midl-agent/package.json"
      provides: "Project manifest with @octokit/rest dependency"
      contains: "@octokit/rest"
    - path: "midl-agent/.env.example"
      provides: "Environment variable template"
      contains: "GITHUB_TOKEN"
  key_links:
    - from: "midl-agent/src/search/github-client.ts"
      to: "@octokit/rest"
      via: "import and instantiation"
      pattern: "new Octokit"
    - from: "midl-agent/src/search/github-client.ts"
      to: "environment config"
      via: "token parameter in constructor"
      pattern: "auth.*token"
    - from: "midl-agent/src/search/github-client.ts"
      to: "rate limit handling"
      via: "response header checking and retry/backoff"
      pattern: "x-ratelimit-remaining"
---

<objective>
Build the GitHub API client that authenticates, queries issues, handles rate limits, and supports testing mode.

Purpose: This is the foundation all search features depend on. Without a working, rate-limited GitHub client, nothing else can be built.
Output: A tested GitHubClient class using @octokit/rest that Phase 2 will use for search queries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@midl-agent/claude.json
@midl-agent-improvement-patch/midl-agent-improvement-patch/CODE-TEMPLATES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project setup, types, and GitHub client with rate limiting</name>
  <files>
    midl-agent/package.json
    midl-agent/tsconfig.json
    midl-agent/src/types/search-types.ts
    midl-agent/src/search/github-client.ts
    midl-agent/.env.example
  </files>
  <action>
    1. Initialize the midl-agent directory as a Node.js project:
       - Run `npm init -y` inside midl-agent/
       - Install dependencies: `npm install @octokit/rest`
       - Install dev dependencies: `npm install -D typescript @types/node vitest`
       - Create a minimal tsconfig.json targeting ES2020, module NodeNext, outDir dist/, strict mode enabled

    2. Create midl-agent/src/types/search-types.ts with these types:
       - `GitHubIssueResult`: { number, title, url, status: "open"|"closed", labels: string[], comments: number, createdAt: string, updatedAt: string, body: string, author: string }
       - `GitHubClientConfig`: { token: string, owner: string, repo: string, testingMode?: boolean }
       - `RateLimitInfo`: { remaining: number, limit: number, resetAt: Date }
       - Export a constant `PRODUCTION_REPO = { owner: "midl-xyz", repo: "midl-js" }`
       - Export a constant `TESTING_REPO = { owner: "midman001", repo: "agent-testing" }`

    3. Create midl-agent/src/search/github-client.ts with a `GitHubClient` class:
       - Constructor accepts `GitHubClientConfig`. If token is empty/missing, throw an Error with message "GitHub token is required. Set GITHUB_TOKEN in your environment."
       - Store an Octokit instance created with `new Octokit({ auth: config.token })`
       - If `config.testingMode` is true, use TESTING_REPO constants for owner/repo. Otherwise use PRODUCTION_REPO (or config.owner/config.repo if provided).
       - Method `async searchIssues(query: string, options?: { limit?: number, includeClosedIssues?: boolean }): Promise<GitHubIssueResult[]>`:
         * Build GitHub search query: `${query} repo:${owner}/${repo} is:issue` plus `is:open` or nothing based on includeClosedIssues
         * Call `this.octokit.rest.search.issuesAndPullRequests({ q, per_page: options.limit ?? 5 })`
         * Map results to GitHubIssueResult type
         * Return mapped results
       - Method `async getIssue(issueNumber: number): Promise<GitHubIssueResult>`:
         * Call `this.octokit.rest.issues.get({ owner, repo, issue_number })`
         * Map to GitHubIssueResult and return
       - Method `async getRateLimitInfo(): Promise<RateLimitInfo>`:
         * Call `this.octokit.rest.rateLimit.get()`
         * Return { remaining, limit, resetAt } from response
       - Private method `checkRateLimit()`:
         * Call getRateLimitInfo()
         * If remaining < 100, log a warning: "GitHub API rate limit low: {remaining}/{limit} requests remaining. Resets at {resetAt}"
         * If remaining === 0, throw an Error: "GitHub API rate limit exhausted. Resets at {resetAt}. Please wait before retrying."
       - Call `checkRateLimit()` at the start of searchIssues and getIssue
       - Wrap all Octokit calls in try/catch. On 401 errors, throw with message "GitHub authentication failed. Check your GITHUB_TOKEN." On 403 with rate limit headers, throw with rate limit message. On other errors, throw with "GitHub API error: {status} {message}"

    4. Create midl-agent/.env.example:
       ```
       # GitHub Personal Access Token (requires read:issues scope)
       # Create at: https://github.com/settings/tokens
       GITHUB_TOKEN=your_token_here

       # Set to "true" to use midman001/agent-testing repo instead of midl-xyz/midl-js
       MIDL_TESTING_MODE=false
       ```
  </action>
  <verify>
    - `cd midl-agent && npx tsc --noEmit` compiles without errors
    - `node -e "require('./node_modules/@octokit/rest')"` confirms octokit is installed
    - Verify github-client.ts exports GitHubClient class
  </verify>
  <done>
    TypeScript compiles cleanly. GitHubClient class exists with searchIssues, getIssue, getRateLimitInfo methods. Rate limit checking throws on exhaustion. Auth errors throw descriptive messages. Testing mode switches repo target.
  </done>
</task>

<task type="auto">
  <name>Task 2: Smoke tests for GitHub client</name>
  <files>
    midl-agent/src/search/github-client.test.ts
    midl-agent/vitest.config.ts
  </files>
  <action>
    1. Create midl-agent/vitest.config.ts:
       ```ts
       import { defineConfig } from 'vitest/config';
       export default defineConfig({ test: { globals: true } });
       ```

    2. Create midl-agent/src/search/github-client.test.ts with these test cases using vitest:

       - "throws on missing token": `expect(() => new GitHubClient({ token: "", owner: "", repo: "" })).toThrow("GitHub token is required")`
       - "throws on empty string token": same with token: "  "
       - "uses production repo by default": Create client with valid token config (no testingMode). Access the internal owner/repo (you may need to expose via a getter or test the search query string). Verify owner is "midl-xyz" and repo is "midl-js".
       - "uses testing repo when testingMode is true": Create client with `testingMode: true`. Verify owner is "midman001" and repo is "agent-testing".
       - "searchIssues builds correct query": Mock `octokit.rest.search.issuesAndPullRequests` to return `{ data: { items: [] } }`. Call `searchIssues("wallet error")`. Verify the mock was called with q containing "wallet error" and "repo:midl-xyz/midl-js".
       - "searchIssues maps results correctly": Mock the search call to return a sample issue item. Verify the returned GitHubIssueResult has all fields mapped.
       - "handles rate limit exhaustion": Mock `octokit.rest.rateLimit.get` to return remaining: 0. Call searchIssues. Expect it to throw "rate limit exhausted".
       - "handles auth failure (401)": Mock search to reject with `{ status: 401 }`. Expect throw "authentication failed".

       Use vitest's `vi.mock` or manual mocking for Octokit. The simplest approach: in the constructor, store `this.octokit` as a public/protected property, then in tests create the client with a dummy token and replace `client.octokit` with a mock object before calling methods. Or use dependency injection by accepting an optional Octokit instance in the constructor.

       IMPORTANT: To make mocking easier, update github-client.ts constructor to accept an optional `octokit` parameter for testing: `constructor(config: GitHubClientConfig, octokit?: Octokit)`. If provided, use it instead of creating a new one. This avoids needing to mock the module.

    3. Add a test script to package.json: `"test": "vitest run"`

    4. Run `cd midl-agent && npm test` and verify all tests pass.
  </action>
  <verify>
    `cd midl-agent && npm test` -- all tests pass, zero failures
  </verify>
  <done>
    8 test cases pass covering: token validation, repo switching (production/testing), query building, result mapping, rate limit exhaustion handling, and auth failure handling. No real GitHub API calls are made in tests.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase success criteria:

1. **Auth from env config**: GitHubClient constructor accepts token, .env.example documents GITHUB_TOKEN
2. **Query issues**: searchIssues method exists and builds correct GitHub search query for midl-xyz/midl-js
3. **Rate limit handling**: checkRateLimit throws on exhaustion, warns when low -- tested
4. **Auth error surfacing**: 401 errors produce clear "authentication failed" message -- tested
5. **Testing mode**: testingMode flag switches to midman001/agent-testing -- tested

Run: `cd midl-agent && npm test && npx tsc --noEmit`
</verification>

<success_criteria>
- `npm test` passes all 8+ tests with 0 failures
- `npx tsc --noEmit` compiles with 0 errors
- GitHubClient exported from src/search/github-client.ts
- @octokit/rest in package.json dependencies
- .env.example exists with GITHUB_TOKEN and MIDL_TESTING_MODE
- No hardcoded tokens anywhere in source
</success_criteria>

<output>
After completion, create `.planning/phases/01-github-api-foundation/01-01-SUMMARY.md`
</output>
