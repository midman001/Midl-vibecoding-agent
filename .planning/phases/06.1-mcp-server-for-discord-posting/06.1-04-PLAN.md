---
phase: 06.1-mcp-server-for-discord-posting
plan: 04
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - midl-agent/src/search/workflow-orchestrator.ts
  - midl-agent/src/search/workflow-orchestrator.test.ts
  - midl-agent/MIDL-AGENT.md
  - midl-agent/claude.json
  - midl-agent/MCP-SETUP.md
autonomous: true

must_haves:
  truths:
    - "WorkflowOrchestrator no longer has postToDiscord method"
    - "Agent prompts offer to post via MCP tool"
    - "claude.json configures MCP server connection WITHOUT bot credentials"
    - "MCP_API_KEY is the ONLY credential agent users need"
    - "MCP server runs separately with its own credentials"
  artifacts:
    - path: "midl-agent/src/search/workflow-orchestrator.ts"
      provides: "Simplified orchestrator without direct Discord posting"
      exports: ["WorkflowOrchestrator", "WorkflowResult"]
    - path: "midl-agent/claude.json"
      provides: "Agent config with MCP server connection (no bot credentials)"
      contains: "mcpServers"
    - path: "midl-agent/MCP-SETUP.md"
      provides: "Setup instructions for MCP server operators"
      contains: "DISCORD_BOT_TOKEN"
  key_links:
    - from: "midl-agent/claude.json"
      to: "MCP server"
      via: "mcpServers configuration"
      pattern: "midl-discord-poster"
    - from: "midl-agent/MIDL-AGENT.md"
      to: "MCP posting workflow"
      via: "prompt instructions"
      pattern: "create_discord_thread|MCP_API_KEY"
---

<objective>
Refactor WorkflowOrchestrator to remove direct Discord posting and update agent configuration to use MCP for posting WITHOUT exposing bot credentials.

Purpose: The existing postToDiscord() method requires bot token in the agent's environment, which can't be distributed publicly. This plan removes that method and configures the agent to use an externally-running MCP server. Agent users only need MCP_API_KEY - the MCP server operator (MIDL team or self-hosters) manages bot credentials separately.

Output: WorkflowOrchestrator without postToDiscord, agent configured to discover and use externally-running MCP server for Discord posting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-01-SUMMARY.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/MIDL-AGENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove postToDiscord from WorkflowOrchestrator</name>
  <files>midl-agent/src/search/workflow-orchestrator.ts, midl-agent/src/search/workflow-orchestrator.test.ts</files>
  <action>
1. Update `src/search/workflow-orchestrator.ts`:
   - Remove ForumPoster import and type
   - Remove forumPoster from constructor deps interface
   - Remove forumPoster property from class
   - Delete postToDiscord() method entirely
   - Update formatReportDraftResponse():
     - Remove "Want to share this on Discord? I can post it to the MIDL support forum for you."
     - Replace with: "To share this on Discord, use the `create_discord_thread` MCP tool. Make sure you have your MCP_API_KEY configured."
     - Also add: "Run `/setup-mcp` in the MIDL Discord server to get your API key if you don't have one."

2. Update `src/search/workflow-orchestrator.test.ts`:
   - Remove any tests for postToDiscord()
   - Remove ForumPoster mock setup
   - Update tests that checked for Discord posting functionality
   - Add test that formatReportDraftResponse mentions MCP tool
  </action>
  <verify>Run `npm run build` succeeds. Run `npm test` - all orchestrator tests pass.</verify>
  <done>WorkflowOrchestrator no longer has postToDiscord method. Response mentions MCP tool for Discord posting.</done>
</task>

<task type="auto">
  <name>Task 2: Create claude.json with credential-free MCP configuration</name>
  <files>midl-agent/claude.json, midl-agent/MCP-SETUP.md</files>
  <action>
**Architecture decision:** MCP server runs as a SEPARATE process from the agent. The agent does NOT spawn the MCP server as a subprocess. This separation ensures:
- Agent users never see or need Discord bot credentials
- MCP server can be operated by MIDL team (hosted) or self-hosters
- Agent only needs MCP_API_KEY to authenticate with the running MCP server

**Create `midl-agent/claude.json`:**

```json
{
  "name": "midl-agent",
  "description": "MIDL SDK assistant for Web3 development on Bitcoin",
  "mcpServers": {
    "midl-discord-poster": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-proxy", "--endpoint", "http://localhost:3847"]
    }
  }
}
```

Notes on this configuration:
- Uses mcp-proxy to connect to an HTTP endpoint (the separately-running MCP server)
- MCP server runs on localhost:3847 by default (can be customized)
- NO Discord credentials in this file - only server location
- For MIDL-hosted production: endpoint would be "https://mcp.midl.xyz" or similar
- MCP_API_KEY is passed as a tool parameter, not as env var in claude.json

**Create `midl-agent/MCP-SETUP.md`:**

```markdown
# MCP Server Setup for Discord Posting

This document is for MCP server operators (MIDL team or self-hosters).
Regular agent users do NOT need this - they only need an MCP_API_KEY.

## For Agent Users

1. Run `/setup-mcp` in the MIDL Discord server to get your API key
2. Add to your `.env` file: `MCP_API_KEY=your-key-here`
3. The agent will use MIDL's hosted MCP server automatically

## For Self-Hosters / MCP Server Operators

If you want to run your own MCP server (for development or private deployment):

### Prerequisites

- Discord bot with permissions to create forum threads
- Node.js 18+

### Environment Variables

Create `.env` in the mcp-server directory:

```env
DISCORD_BOT_TOKEN=your-bot-token
DISCORD_GUILD_ID=your-guild-id
DISCORD_FORUM_CHANNEL_ID=your-forum-channel-id
MCP_SERVER_PORT=3847
```

### Running the Server

```bash
cd midl-agent
npm run mcp-server
```

The MCP server listens on `http://localhost:3847` by default.

### Updating Agent Configuration

For local development, update `claude.json` endpoint:
```json
"--endpoint", "http://localhost:3847"
```

For production, point to your hosted server:
```json
"--endpoint", "https://your-mcp-server.example.com"
```
```
  </action>
  <verify>
1. claude.json is valid JSON
2. claude.json contains NO Discord credential references (no DISCORD_BOT_TOKEN, DISCORD_GUILD_ID, DISCORD_FORUM_CHANNEL_ID)
3. claude.json uses mcp-proxy with HTTP endpoint
4. MCP-SETUP.md exists with separate sections for users vs operators
  </verify>
  <done>claude.json configures MCP server connection without exposing bot credentials. MCP-SETUP.md documents the separation of concerns.</done>
</task>

<task type="auto">
  <name>Task 3: Update agent prompts for MCP-based Discord posting</name>
  <files>midl-agent/MIDL-AGENT.md</files>
  <action>
Update `midl-agent/MIDL-AGENT.md` (agent system prompt):

1. Find the section about bug reports / diagnostic reports

2. Add/update section for Discord posting:
   ```markdown
   ## Posting to Discord

   After generating a diagnostic report, offer to post it to the MIDL Discord support forum.

   **To post a report:**
   1. Use the `create_discord_thread` MCP tool
   2. Requires MCP_API_KEY in user's .env file
   3. Tool parameters:
      - apiKey: The user's MCP API key (from MCP_API_KEY env var)
      - reportMarkdown: The full diagnostic report
      - title: A short title (max 100 chars)
      - summary: Brief description of the issue
      - authorName: (optional) User's name

   **If user doesn't have API key:**
   - Direct them to run `/setup-mcp` in the MIDL Discord server
   - The command will generate and DM them an API key
   - They add it to .env as MCP_API_KEY

   **Rate limits:** 5 posts per hour per API key

   **Before posting:**
   - Use `list_recent_threads` to check for similar existing threads
   - Prevents duplicate reports
   ```

3. Update the response template to mention MCP posting option

4. Remove any references to direct bot token configuration for agents

5. Emphasize: Users only need MCP_API_KEY, nothing else for Discord posting
  </action>
  <verify>MIDL-AGENT.md contains MCP posting instructions. No references to DISCORD_BOT_TOKEN for agent users. Emphasizes MCP_API_KEY is the only credential needed.</verify>
  <done>Agent prompts guide users through MCP-based Discord posting with API key setup. No bot credentials exposed to users.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm test` passes (orchestrator tests updated)
3. WorkflowOrchestrator has no postToDiscord method
4. claude.json exists with valid MCP server configuration
5. claude.json contains NO Discord bot credentials (grep for DISCORD_ returns nothing)
6. MCP-SETUP.md documents operator setup separately from user setup
7. MIDL-AGENT.md documents MCP posting workflow
8. No references to direct bot token usage for agent users anywhere
</verification>

<success_criteria>
- WorkflowOrchestrator simplified (no postToDiscord)
- Agent response mentions MCP tool for Discord posting
- claude.json configures MCP server connection via HTTP proxy (no credentials)
- MCP_API_KEY is the ONLY credential documented for agent users
- MCP-SETUP.md provides clear separation: user setup vs operator setup
- Agent prompts explain API key setup via /setup-mcp
- Rate limit (5/hour) mentioned in prompts
- list_recent_threads mentioned for duplicate checking
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-04-SUMMARY.md`
</output>
