---
phase: 06.1-mcp-server-for-discord-posting
plan: 04
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - midl-agent/src/search/workflow-orchestrator.ts
  - midl-agent/src/search/workflow-orchestrator.test.ts
  - midl-agent/MIDL-AGENT.md
  - midl-agent/claude.json
autonomous: true

must_haves:
  truths:
    - "WorkflowOrchestrator no longer has postToDiscord method"
    - "Agent prompts offer to post via MCP tool"
    - "claude.json configures MCP server connection"
    - "MCP_API_KEY environment variable documented"
  artifacts:
    - path: "midl-agent/src/search/workflow-orchestrator.ts"
      provides: "Simplified orchestrator without direct Discord posting"
      exports: ["WorkflowOrchestrator", "WorkflowResult"]
    - path: "midl-agent/claude.json"
      provides: "Agent config with MCP server connection"
      contains: "mcpServers"
  key_links:
    - from: "midl-agent/claude.json"
      to: "MCP server"
      via: "mcpServers configuration"
      pattern: "midl-discord-poster"
    - from: "midl-agent/MIDL-AGENT.md"
      to: "MCP posting workflow"
      via: "prompt instructions"
      pattern: "create_discord_thread|MCP_API_KEY"
---

<objective>
Refactor WorkflowOrchestrator to remove direct Discord posting and update agent configuration to use MCP for posting.

Purpose: The existing postToDiscord() method requires bot token in the agent's environment, which can't be distributed publicly. This plan removes that method and configures the agent to use the MCP server instead.

Output: WorkflowOrchestrator without postToDiscord, agent configured to discover and use MCP server for Discord posting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-01-SUMMARY.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/MIDL-AGENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove postToDiscord from WorkflowOrchestrator</name>
  <files>midl-agent/src/search/workflow-orchestrator.ts, midl-agent/src/search/workflow-orchestrator.test.ts</files>
  <action>
1. Update `src/search/workflow-orchestrator.ts`:
   - Remove ForumPoster import and type
   - Remove forumPoster from constructor deps interface
   - Remove forumPoster property from class
   - Delete postToDiscord() method entirely
   - Update formatReportDraftResponse():
     - Remove "Want to share this on Discord? I can post it to the MIDL support forum for you."
     - Replace with: "To share this on Discord, use the `create_discord_thread` MCP tool. Make sure you have your MCP_API_KEY configured."
     - Also add: "Run `/setup-mcp` in the MIDL Discord server to get your API key if you don't have one."

2. Update `src/search/workflow-orchestrator.test.ts`:
   - Remove any tests for postToDiscord()
   - Remove ForumPoster mock setup
   - Update tests that checked for Discord posting functionality
   - Add test that formatReportDraftResponse mentions MCP tool
  </action>
  <verify>Run `npm run build` succeeds. Run `npm test` - all orchestrator tests pass.</verify>
  <done>WorkflowOrchestrator no longer has postToDiscord method. Response mentions MCP tool for Discord posting.</done>
</task>

<task type="auto">
  <name>Task 2: Create claude.json with MCP server configuration</name>
  <files>midl-agent/claude.json</files>
  <action>
Create `midl-agent/claude.json` (Claude Code agent configuration):

```json
{
  "name": "midl-agent",
  "description": "MIDL SDK assistant for Web3 development on Bitcoin",
  "mcpServers": {
    "midl-discord-poster": {
      "command": "node",
      "args": ["./dist/mcp-server/index.js"],
      "env": {
        "DISCORD_BOT_TOKEN": "${DISCORD_BOT_TOKEN}",
        "DISCORD_GUILD_ID": "${DISCORD_GUILD_ID}",
        "DISCORD_FORUM_CHANNEL_ID": "${DISCORD_FORUM_CHANNEL_ID}"
      }
    }
  }
}
```

Notes:
- The MCP server runs as a subprocess managed by Claude Code
- Environment variables are passed through from the user's environment
- For public distribution, the MIDL team hosts the MCP server, so this config will be updated
- For now, this allows local development and testing

Alternative for hosted MCP server (future):
- When MIDL team hosts the server, config would use HTTP transport instead of stdio
- But MCP SDK primarily supports stdio, so hosting strategy TBD
  </action>
  <verify>claude.json is valid JSON. Contains mcpServers with midl-discord-poster entry.</verify>
  <done>claude.json configures MCP server for Claude Code agent.</done>
</task>

<task type="auto">
  <name>Task 3: Update agent prompts for MCP-based Discord posting</name>
  <files>midl-agent/MIDL-AGENT.md</files>
  <action>
Update `midl-agent/MIDL-AGENT.md` (agent system prompt):

1. Find the section about bug reports / diagnostic reports

2. Add/update section for Discord posting:
   ```markdown
   ## Posting to Discord

   After generating a diagnostic report, offer to post it to the MIDL Discord support forum.

   **To post a report:**
   1. Use the `create_discord_thread` MCP tool
   2. Requires MCP_API_KEY in user's .env file
   3. Tool parameters:
      - apiKey: The user's MCP API key (from MCP_API_KEY env var)
      - reportMarkdown: The full diagnostic report
      - title: A short title (max 100 chars)
      - summary: Brief description of the issue
      - authorName: (optional) User's name

   **If user doesn't have API key:**
   - Direct them to run `/setup-mcp` in the MIDL Discord server
   - The command will generate and DM them an API key
   - They add it to .env as MCP_API_KEY

   **Rate limits:** 5 posts per hour per API key

   **Before posting:**
   - Use `list_recent_threads` to check for similar existing threads
   - Prevents duplicate reports
   ```

3. Update the response template to mention MCP posting option

4. Remove any references to direct bot token configuration for agents
  </action>
  <verify>MIDL-AGENT.md contains MCP posting instructions. No references to DISCORD_BOT_TOKEN for agent users.</verify>
  <done>Agent prompts guide users through MCP-based Discord posting with API key setup.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm test` passes (orchestrator tests updated)
3. WorkflowOrchestrator has no postToDiscord method
4. claude.json exists with valid MCP server configuration
5. MIDL-AGENT.md documents MCP posting workflow
6. No references to direct bot token usage for agent users
</verification>

<success_criteria>
- WorkflowOrchestrator simplified (no postToDiscord)
- Agent response mentions MCP tool for Discord posting
- claude.json configures MCP server connection
- Agent prompts explain API key setup via /setup-mcp
- Rate limit (5/hour) mentioned in prompts
- list_recent_threads mentioned for duplicate checking
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-04-SUMMARY.md`
</output>
