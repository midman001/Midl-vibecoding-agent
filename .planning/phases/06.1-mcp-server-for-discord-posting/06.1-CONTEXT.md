# Phase 6.1: MCP Server for Discord Posting - Context

**Gathered:** 2026-02-02
**Status:** Ready for planning

<domain>
## Phase Boundary

MCP server that enables Claude Code agents to post diagnostic reports to Discord without exposing bot credentials. MIDL team deploys and manages the MCP server (holds bot token). Public developers install the Claude agent with no credentials needed. Agent connects to MCP server to post reports securely.

This phase delivers the secure posting mechanism only. Report generation, Discord bot commands, and agent distribution are separate concerns.

</domain>

<decisions>
## Implementation Decisions

### MCP Server API Design

- Primary tool: `create_discord_thread` (Discord-focused, describes the action)
- Parameters: Both report markdown string + metadata object (title, summary, author name)
  - Agent generates report, provides posting metadata separately
  - Server handles formatting and file creation
- Return type: Success boolean + optional URL
  - `{success: boolean, url?: string}`
  - Agent uses this for user feedback
- Additional tools:
  - `check_server_status` - verify Discord/bot connectivity before posting
  - `list_recent_threads` - check if similar reports exist

### Authentication & Authorization

- Auth method: API key requested via Discord bot command
  - User runs `/setup-mcp` in Discord server
  - Bot generates API key tied to Discord user ID
  - No external registration system needed
- API key delivery: Both ephemeral message (only user sees) + DM backup
  - Redundant delivery for reliability
  - User can dismiss ephemeral, still has DM copy
- Rate limits: Conservative - 5 posts/hour per API key
  - Prevents abuse while allowing legitimate use
  - Strict limits since posting is to public forum

### Agent Integration

- MCP server discovery: Auto-discover via claude.json config
  - MCP server URL defined in agent config file
  - No environment variables for server location
- API key storage: .env file with `MCP_API_KEY` variable
  - Standard environment variable approach
  - User copies key from Discord bot to .env
- Fallback behavior: Show error, abort posting (fail fast)
  - If MCP server unavailable or API key missing, display clear error
  - No graceful degradation to manual posting
  - User must configure MCP access to use posting feature
- Connectivity check: Only validate when posting (lazy validation)
  - No startup health check
  - Only verify when user attempts to post

### WorkflowOrchestrator Refactoring

- Remove `postToDiscord()` method entirely
  - Delete existing method that requires bot token
  - MCP is the only way to post from agent
- Posting flow: Agent suggests posting + user has direct command
  - After generating report, agent offers: "Would you like me to post this to Discord?"
  - User can accept offer OR use `/post-to-discord` command directly
  - Both trigger MCP `create_discord_thread` call
- Success response: Show URL with success message
  - Format: "Posted to Discord: [clickable URL]"
  - User can immediately navigate to the thread
  - Failure shows error from MCP server

### Claude's Discretion

- MCP server deployment architecture (hosting, scaling, monitoring)
- API key generation algorithm and storage
- Thread URL validation and error handling details
- Exact error messages for various failure modes
- `/setup-mcp` Discord command implementation details

</decisions>

<specifics>
## Specific Ideas

- Keep everything in Discord ecosystem - users get API keys through Discord bot, not external registration
- `/post-to-discord` is a Claude Code agent command (user â†’ agent), NOT a Discord bot slash command
- Conservative rate limits (5/hour) since forum posting is public and abuse-prone
- Fail fast on configuration errors - don't silently degrade, force proper setup

</specifics>

<deferred>
## Deferred Ideas

None - discussion stayed within phase scope

</deferred>

---

*Phase: 06.1-mcp-server-for-discord-posting*
*Context gathered: 2026-02-02*
