---
phase: 06.1-mcp-server-for-discord-posting
plan: 04
subsystem: agent-integration
tags: [mcp, workflow-orchestrator, claude-json, documentation]

# Dependency graph
requires:
  - phase: 06.1-01
    provides: McpDiscordServer with MCP tools
provides:
  - Simplified WorkflowOrchestrator without direct Discord posting
  - Agent config with MCP server connection (no bot credentials)
  - Setup documentation for MCP server operators
affects: [06.1-05]

# Tech tracking
tech-stack:
  added: []
  patterns: ["MCP proxy for HTTP transport to external server", "Credential separation: agent vs operator"]

key-files:
  created:
    - midl-agent/MCP-SETUP.md
  modified:
    - midl-agent/src/search/workflow-orchestrator.ts
    - midl-agent/src/search/workflow-orchestrator.test.ts
    - midl-agent/claude.json
    - midl-agent/system-prompt.md

key-decisions:
  - "Remove postToDiscord method entirely - MCP is the only posting mechanism"
  - "Agent users need only MCP_API_KEY, not Discord bot credentials"
  - "MCP server runs separately from agent (HTTP endpoint via mcp-proxy)"
  - "Default endpoint localhost:3847 for local development"

patterns-established:
  - "Credential separation: sensitive tokens on server, API keys on client"
  - "MCP proxy connects to HTTP endpoint for external MCP servers"

# Metrics
duration: 6min
completed: 2026-02-03
---

# Phase 6.1 Plan 4: Refactor Orchestrator for MCP-Based Discord Posting Summary

**Simplified WorkflowOrchestrator with MCP-based posting, agent configured for external MCP server connection without bot credentials**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-03T12:14:02Z
- **Completed:** 2026-02-03T12:20:03Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Removed postToDiscord method from WorkflowOrchestrator
- Updated response text to mention create_discord_thread MCP tool
- Added mcpServers configuration to claude.json with mcp-proxy
- Created MCP-SETUP.md with user vs operator documentation
- Updated system-prompt.md with MCP posting workflow

## Task Commits

Each task was committed atomically:

1. **Task 1: Remove postToDiscord from WorkflowOrchestrator** - `9f62cbb` (refactor)
2. **Task 2: Create claude.json with credential-free MCP configuration** - `4020912` (feat)
3. **Task 3: Update agent prompts for MCP-based Discord posting** - `6040f81` (docs)

## Files Created/Modified
- `midl-agent/src/search/workflow-orchestrator.ts` - Removed ForumPoster dependency and postToDiscord method
- `midl-agent/src/search/workflow-orchestrator.test.ts` - Added test for MCP tool mention in response
- `midl-agent/claude.json` - Added mcpServers with mcp-proxy configuration
- `midl-agent/MCP-SETUP.md` - New file with setup docs for users and operators
- `midl-agent/system-prompt.md` - Updated Discord section with MCP posting workflow

## Decisions Made
- MCP server runs as separate process, not spawned by agent (security)
- Agent uses mcp-proxy NPX package to connect via HTTP
- Default endpoint is localhost:3847 for local development
- MCP_API_KEY is the ONLY credential agent users need
- Bot credentials remain exclusively on MCP server side

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed broken import path in issue-creator.test.ts**
- **Found during:** Task 1 test verification
- **Issue:** Test file imported BugReportGenerator from wrong path (`./bug-report-generator.js` instead of `../bug-report-generator.js`)
- **Fix:** Updated import to correct relative path
- **Files modified:** midl-agent/src/search/legacy/issue-creator.test.ts
- **Note:** This was a pre-existing issue, not introduced by this plan

## Issues Encountered
None - all tasks executed smoothly.

## Credential Security Model

```
Agent User                    MCP Server Operator
-----------                   -------------------
MCP_API_KEY (in .env)        DISCORD_BOT_TOKEN
                             DISCORD_GUILD_ID
                             DISCORD_FORUM_CHANNEL_ID
```

Users never see or need Discord bot credentials. The MCP server (operated by MIDL team or self-hosters) holds all Discord credentials.

## Next Phase Readiness
- WorkflowOrchestrator simplified and ready
- MCP server configuration in place
- Agent prompts document MCP posting workflow
- Ready for Plan 5: Final integration testing and cleanup

---
*Phase: 06.1-mcp-server-for-discord-posting*
*Completed: 2026-02-03*
