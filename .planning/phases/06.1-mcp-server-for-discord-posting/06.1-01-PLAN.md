---
phase: 06.1-mcp-server-for-discord-posting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/mcp-server/index.ts
  - midl-agent/src/mcp-server/types.ts
  - midl-agent/src/mcp-server/server.ts
  - midl-agent/package.json
autonomous: true

must_haves:
  truths:
    - "MCP server starts and listens on stdio transport"
    - "check_server_status tool returns Discord connectivity status"
    - "Server validates API key header on all tool calls"
  artifacts:
    - path: "midl-agent/src/mcp-server/index.ts"
      provides: "MCP server entry point and barrel export"
      exports: ["startMcpServer"]
    - path: "midl-agent/src/mcp-server/types.ts"
      provides: "Type definitions for MCP tools and API keys"
      exports: ["McpServerConfig", "ApiKeyRecord", "CreateThreadInput", "CreateThreadResult"]
    - path: "midl-agent/src/mcp-server/server.ts"
      provides: "McpServer class with tool registration"
      exports: ["McpServer"]
  key_links:
    - from: "midl-agent/src/mcp-server/server.ts"
      to: "@modelcontextprotocol/sdk"
      via: "McpServer import and tool registration"
      pattern: "import.*@modelcontextprotocol/sdk"
    - from: "midl-agent/src/mcp-server/server.ts"
      to: "check_server_status tool"
      via: "registerTool call"
      pattern: "registerTool.*check_server_status"
---

<objective>
Create the MCP server foundation with @modelcontextprotocol/sdk, including types, server setup, and a basic status check tool.

Purpose: Establish the MCP server infrastructure that Claude agents will connect to for Discord posting. This foundation enables secure, credential-free Discord integration for public agent distribution.

Output: Working MCP server package that responds to check_server_status tool calls with Discord bot connectivity status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@midl-agent/src/discord/discord-client.ts
@midl-agent/src/discord/types.ts
@midl-agent/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP SDK dependency and create types</name>
  <files>midl-agent/package.json, midl-agent/src/mcp-server/types.ts</files>
  <action>
1. Add @modelcontextprotocol/sdk and zod@3 to dependencies in package.json:
   - `npm install @modelcontextprotocol/sdk zod@3`

2. Create `src/mcp-server/types.ts` with:
   - `McpServerConfig` interface: { discordBotToken: string, guildId: string, forumChannelId: string }
   - `ApiKeyRecord` interface: { apiKey: string, discordUserId: string, createdAt: Date, postsThisHour: number, lastPostTime: Date | null }
   - `CreateThreadInput` interface: { reportMarkdown: string, title: string, summary: string, authorName?: string }
   - `CreateThreadResult` interface: { success: boolean, url?: string, error?: string }
   - `RateLimitResult` interface: { allowed: boolean, remaining: number, resetInSeconds: number }
   - Export `loadMcpServerConfig()` function that reads DISCORD_BOT_TOKEN, DISCORD_GUILD_ID, DISCORD_FORUM_CHANNEL_ID from env vars (throw if missing)
   - Constants: `RATE_LIMIT_POSTS_PER_HOUR = 5`, `RATE_LIMIT_WINDOW_MS = 3600000`
  </action>
  <verify>Run `npm ls @modelcontextprotocol/sdk` shows package installed. Run `npx tsc --noEmit` passes with no errors in types.ts.</verify>
  <done>Package.json has MCP SDK dependency. Types file exports all interfaces and loadMcpServerConfig function.</done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server with check_server_status tool</name>
  <files>midl-agent/src/mcp-server/server.ts, midl-agent/src/mcp-server/index.ts</files>
  <action>
1. Create `src/mcp-server/server.ts`:
   - Import McpServer from "@modelcontextprotocol/sdk/server/mcp.js"
   - Import StdioServerTransport from "@modelcontextprotocol/sdk/server/stdio.js"
   - Import z from "zod"
   - Import DiscordClient from "../discord/discord-client.js"
   - Import types from "./types.js"

   - Create `McpDiscordServer` class:
     - Constructor accepts McpServerConfig + optional apiKeyStore (Map<string, ApiKeyRecord>)
     - Private discordClient: DiscordClient (lazy initialized)
     - Private mcpServer: McpServer instance with name="midl-discord-poster", version="1.0.0"
     - Private method `validateApiKey(apiKey: string): ApiKeyRecord | null` - looks up in store
     - Private method `ensureDiscordConnection(): Promise<void>` - connects if not connected

   - Register `check_server_status` tool:
     - inputSchema: { apiKey: z.string().describe("Your MCP API key from /setup-mcp command") }
     - Handler:
       1. Validate API key, return error if invalid
       2. Try to connect to Discord if not connected
       3. Return { connected: boolean, guildName?: string, forumChannelName?: string, error?: string }
     - Return content as text with JSON stringified result

   - Public method `start(): Promise<void>`:
     - Create StdioServerTransport
     - Connect server to transport
     - Log to stderr "MIDL MCP Server running on stdio"

2. Create `src/mcp-server/index.ts`:
   - Export { McpDiscordServer } from "./server.js"
   - Export * from "./types.js"
   - Export async function `startMcpServer()` that creates server with loadMcpServerConfig() and starts it
  </action>
  <verify>Run `npx tsc --noEmit` passes. Run `npm run build` succeeds.</verify>
  <done>McpDiscordServer class exists with check_server_status tool registered. Server can be started via startMcpServer() export.</done>
</task>

<task type="auto">
  <name>Task 3: Add MCP server npm script and test basic connectivity</name>
  <files>midl-agent/package.json</files>
  <action>
1. Add npm script to package.json:
   - "mcp-server": "npx tsx src/mcp-server/index.ts"

2. Create a simple manual test by:
   - Ensure .env has DISCORD_BOT_TOKEN, DISCORD_GUILD_ID, DISCORD_FORUM_CHANNEL_ID set (reuse from Phase 6)
   - Build the project: `npm run build`
   - Verify the server file compiles without runtime errors

3. Note for testing: MCP servers use stdio transport and require an MCP client to test interactively. For now, verify:
   - TypeScript compiles successfully
   - Server can be imported without throwing
   - Types are correctly exported
  </action>
  <verify>Run `npm run build` succeeds. Importing the server module does not throw: `node -e "import('./dist/mcp-server/index.js').then(m => console.log(Object.keys(m)))"`</verify>
  <done>Package.json has mcp-server script. Build succeeds. Module exports McpDiscordServer, startMcpServer, and all types.</done>
</task>

</tasks>

<verification>
1. `npm ls @modelcontextprotocol/sdk` shows package installed
2. `npm run build` completes without errors
3. `node -e "import('./dist/mcp-server/index.js').then(m => console.log(Object.keys(m)))"` prints exports including McpDiscordServer, startMcpServer
4. Types file contains all required interfaces
</verification>

<success_criteria>
- MCP SDK installed as dependency
- McpDiscordServer class with check_server_status tool
- Server starts on stdio transport
- API key validation infrastructure in place (store is a Map for now)
- All code compiles and builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-01-SUMMARY.md`
</output>
