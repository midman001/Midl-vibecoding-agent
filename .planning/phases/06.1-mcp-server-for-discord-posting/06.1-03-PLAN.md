---
phase: 06.1-mcp-server-for-discord-posting
plan: 03
type: execute
wave: 2
depends_on: ["06.1-01", "06.1-02"]
files_modified:
  - midl-agent/src/mcp-server/server.ts
  - midl-agent/src/mcp-server/thread-tracker.ts
autonomous: true

must_haves:
  truths:
    - "create_discord_thread tool posts report and returns thread URL"
    - "list_recent_threads tool shows user's recent posts"
    - "Rate limit is enforced on create_discord_thread"
    - "All tools require valid API key"
  artifacts:
    - path: "midl-agent/src/mcp-server/server.ts"
      provides: "MCP server with all 3 tools registered"
      contains: ["create_discord_thread", "list_recent_threads"]
    - path: "midl-agent/src/mcp-server/thread-tracker.ts"
      provides: "Tracks recent threads per API key for list_recent_threads"
      exports: ["ThreadTracker"]
  key_links:
    - from: "midl-agent/src/mcp-server/server.ts"
      to: "midl-agent/src/discord/forum-poster.ts"
      via: "ForumPoster.postReport()"
      pattern: "forumPoster\\.postReport"
    - from: "midl-agent/src/mcp-server/server.ts"
      to: "midl-agent/src/mcp-server/api-key-store.ts"
      via: "checkRateLimit and recordPost"
      pattern: "checkRateLimit|recordPost"
---

<objective>
Implement the core MCP tools for Discord posting: create_discord_thread and list_recent_threads.

Purpose: These tools enable Claude agents to post diagnostic reports to Discord and check for existing threads. This is the primary functionality that allows public agent distribution without credential exposure.

Output: Fully functional MCP server with all three tools (check_server_status, create_discord_thread, list_recent_threads).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-01-SUMMARY.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-02-SUMMARY.md
@midl-agent/src/discord/forum-poster.ts
@midl-agent/src/mcp-server/server.ts
@midl-agent/src/mcp-server/api-key-store.ts
@midl-agent/src/mcp-server/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThreadTracker for recent thread history</name>
  <files>midl-agent/src/mcp-server/thread-tracker.ts</files>
  <action>
Create `src/mcp-server/thread-tracker.ts`:

1. Define `ThreadRecord` interface:
   - threadId: string
   - threadUrl: string
   - title: string
   - createdAt: Date
   - apiKey: string (to track who created it)

2. Create `ThreadTracker` class:
   - Private threads: ThreadRecord[] (append-only list)
   - Private maxAge: number = 24 * 60 * 60 * 1000 (24 hours)
   - Private maxThreadsPerKey: number = 10

   - `recordThread(record: Omit<ThreadRecord, 'createdAt'>): void`
     - Add thread with createdAt = new Date()
     - Prune old threads (older than maxAge)

   - `getRecentThreads(apiKey: string): ThreadRecord[]`
     - Filter by apiKey
     - Sort by createdAt descending
     - Return up to maxThreadsPerKey most recent
     - Note: This lets users check their own recent posts to avoid duplicates

   - `getRecentThreadsByTitle(searchTitle: string, limit: number = 5): ThreadRecord[]`
     - Simple case-insensitive title substring search
     - Returns matching threads across all users
     - For duplicate checking before posting

3. Export singleton: `export const threadTracker = new ThreadTracker()`
4. Also export class for testing
  </action>
  <verify>TypeScript compiles. ThreadTracker can record and retrieve threads.</verify>
  <done>ThreadTracker class tracks recent forum threads by API key with 24hr retention.</done>
</task>

<task type="auto">
  <name>Task 2: Implement create_discord_thread MCP tool</name>
  <files>midl-agent/src/mcp-server/server.ts</files>
  <action>
Update `src/mcp-server/server.ts`:

1. Import ForumPoster from "../discord/forum-poster.js"
2. Import threadTracker from "./thread-tracker.js"
3. Import apiKeyStore (use singleton or injected instance)

4. Update McpDiscordServer class:
   - Add private forumPoster: ForumPoster (lazy initialized with discordClient)

5. Register `create_discord_thread` tool:
   - inputSchema using Zod:
     - apiKey: z.string().describe("Your MCP API key")
     - reportMarkdown: z.string().describe("The diagnostic report content in markdown format")
     - title: z.string().max(100).describe("Thread title (max 100 chars)")
     - summary: z.string().describe("Brief summary of the issue")
     - authorName: z.string().optional().describe("Name to display as report author")

   - Handler:
     1. Validate API key, return error if invalid: { success: false, error: "Invalid API key" }
     2. Check rate limit: apiKeyStore.checkRateLimit(apiKey)
        - If not allowed, return { success: false, error: "Rate limit exceeded. ${remaining} posts remaining. Resets in ${resetInSeconds}s" }
     3. Ensure Discord connected (call ensureDiscordConnection())
     4. Initialize ForumPoster if not done
     5. Call forumPoster.postReport({ title, summary, reportMarkdown, reportFilename: auto-generate, authorName })
     6. Record the post: apiKeyStore.recordPost(apiKey)
     7. Track thread: threadTracker.recordThread({ threadId, threadUrl, title, apiKey })
     8. Return { success: true, url: threadUrl }
     9. On error, return { success: false, error: error.message }

   - Return content as text with JSON.stringify(result)
  </action>
  <verify>TypeScript compiles. create_discord_thread tool is registered with correct schema.</verify>
  <done>create_discord_thread tool validates API key, enforces rate limit, posts to Discord, returns thread URL.</done>
</task>

<task type="auto">
  <name>Task 3: Implement list_recent_threads MCP tool</name>
  <files>midl-agent/src/mcp-server/server.ts, midl-agent/src/mcp-server/index.ts</files>
  <action>
1. Update `src/mcp-server/server.ts` - register `list_recent_threads` tool:
   - inputSchema using Zod:
     - apiKey: z.string().describe("Your MCP API key")
     - searchTitle: z.string().optional().describe("Optional: search for threads with similar title")

   - Handler:
     1. Validate API key, return error if invalid
     2. If searchTitle provided:
        - Call threadTracker.getRecentThreadsByTitle(searchTitle)
        - Return matches (to help check for duplicates before posting)
     3. Otherwise:
        - Call threadTracker.getRecentThreads(apiKey)
        - Return user's own recent threads
     4. Format result: { threads: [{ title, url, createdAt }] }

   - Return content as text with JSON.stringify(result)

2. Update `src/mcp-server/index.ts`:
   - Export threadTracker and ThreadTracker from "./thread-tracker.js"

3. Verify all three tools are registered:
   - check_server_status
   - create_discord_thread
   - list_recent_threads
  </action>
  <verify>TypeScript compiles. All three tools registered. list_recent_threads returns thread history.</verify>
  <done>list_recent_threads tool returns user's recent posts or searches by title. All MCP tools complete.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. McpDiscordServer has all three tools registered
3. create_discord_thread enforces rate limiting (5/hour)
4. create_discord_thread posts to Discord via ForumPoster
5. list_recent_threads returns thread history by API key
6. threadTracker tracks threads with 24hr retention
</verification>

<success_criteria>
- create_discord_thread posts reports and returns thread URL
- Rate limit of 5 posts/hour is enforced per API key
- list_recent_threads shows user's recent posts
- list_recent_threads can search by title for duplicate checking
- All tools require valid API key
- Thread history tracked for 24 hours
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-03-SUMMARY.md`
</output>
