---
phase: 06.1-mcp-server-for-discord-posting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/mcp-server/api-key-store.ts
  - midl-agent/src/discord/commands/setup-mcp.ts
  - midl-agent/src/discord/commands/index.ts
  - midl-agent/src/discord/bot.ts
autonomous: true

must_haves:
  truths:
    - "User runs /setup-mcp in Discord and receives API key"
    - "API key is tied to user's Discord ID"
    - "API key is delivered via ephemeral message and DM"
    - "Rate limit of 5 posts/hour is enforced per API key"
  artifacts:
    - path: "midl-agent/src/mcp-server/api-key-store.ts"
      provides: "In-memory API key storage with rate limiting"
      exports: ["ApiKeyStore"]
    - path: "midl-agent/src/discord/commands/setup-mcp.ts"
      provides: "Discord slash command for API key generation"
      exports: ["setupMcpCommand"]
  key_links:
    - from: "midl-agent/src/discord/commands/setup-mcp.ts"
      to: "midl-agent/src/mcp-server/api-key-store.ts"
      via: "ApiKeyStore.createKey()"
      pattern: "createKey.*discordUserId"
    - from: "midl-agent/src/discord/bot.ts"
      to: "midl-agent/src/discord/commands/setup-mcp.ts"
      via: "commandHandler.addCommand(setupMcpCommand)"
      pattern: "addCommand.*setupMcp"
---

<objective>
Implement API key generation and storage with the /setup-mcp Discord command for secure MCP access.

Purpose: Users need API keys to authenticate with the MCP server. This plan creates the key generation flow through Discord, keeping the auth system within the Discord ecosystem (no external registration needed).

Output: Working /setup-mcp command that generates and delivers API keys, with rate limiting enforced on key usage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@midl-agent/src/discord/commands/index.ts
@midl-agent/src/discord/commands/help.ts
@midl-agent/src/discord/bot.ts
@midl-agent/src/mcp-server/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ApiKeyStore with rate limiting</name>
  <files>midl-agent/src/mcp-server/api-key-store.ts</files>
  <action>
Create `src/mcp-server/api-key-store.ts`:

1. Import types from "./types.js" (ApiKeyRecord, RateLimitResult, RATE_LIMIT_POSTS_PER_HOUR, RATE_LIMIT_WINDOW_MS)

2. Create `ApiKeyStore` class:
   - Private store: Map<string, ApiKeyRecord> (apiKey -> record)
   - Private userKeyMap: Map<string, string> (discordUserId -> apiKey) - for lookup by user

   - `createKey(discordUserId: string): string`
     - If user already has a key, revoke old one first
     - Generate API key: `midl_` + 32 random hex chars (use crypto.randomBytes)
     - Create ApiKeyRecord with postsThisHour=0, lastPostTime=null
     - Store in both maps
     - Return the API key

   - `validateKey(apiKey: string): ApiKeyRecord | null`
     - Return record if exists, null otherwise

   - `getKeyForUser(discordUserId: string): string | null`
     - Return existing API key for user, or null

   - `revokeKey(apiKey: string): boolean`
     - Remove from store and userKeyMap
     - Return true if existed

   - `checkRateLimit(apiKey: string): RateLimitResult`
     - Get record, return { allowed: false, remaining: 0, resetInSeconds: 0 } if not found
     - Calculate time since window start (current hour)
     - If lastPostTime is older than RATE_LIMIT_WINDOW_MS ago, reset postsThisHour to 0
     - If postsThisHour >= RATE_LIMIT_POSTS_PER_HOUR, return { allowed: false, remaining: 0, resetInSeconds: calculated }
     - Return { allowed: true, remaining: RATE_LIMIT_POSTS_PER_HOUR - postsThisHour, resetInSeconds: 0 }

   - `recordPost(apiKey: string): void`
     - Increment postsThisHour on the record
     - Update lastPostTime to now

3. Export singleton pattern:
   - Export `const apiKeyStore = new ApiKeyStore()`
   - Also export the class for testing: `export { ApiKeyStore }`
  </action>
  <verify>Run `npx tsc --noEmit` passes. Create rate limit test: create key, record 5 posts, verify 6th is blocked.</verify>
  <done>ApiKeyStore class with createKey, validateKey, checkRateLimit, recordPost methods. Singleton exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create /setup-mcp Discord command</name>
  <files>midl-agent/src/discord/commands/setup-mcp.ts</files>
  <action>
Create `src/discord/commands/setup-mcp.ts`:

1. Import:
   - SlashCommandBuilder, EmbedBuilder from "discord.js"
   - SlashCommand type from "./index.js"
   - apiKeyStore from "../../mcp-server/api-key-store.js"

2. Create `setupMcpCommand: SlashCommand`:
   - data: new SlashCommandBuilder()
     .setName("setup-mcp")
     .setDescription("Generate an API key for the MIDL MCP server (for Claude Code integration)")

   - execute handler:
     1. Get user from interaction.user
     2. Check if user already has key: apiKeyStore.getKeyForUser(user.id)
     3. If exists, ask if they want to regenerate (show warning that old key will stop working)
        - For simplicity in v1: just regenerate and inform them
     4. Generate new key: apiKeyStore.createKey(user.id)
     5. Build success embed with:
        - Title: "MCP API Key Generated"
        - Description explaining what this is for
        - Field "Your API Key": the key (in code block)
        - Field "Setup Instructions":
          1. Add to your .env file: `MCP_API_KEY=<key>`
          2. The MIDL agent will use this to post reports
        - Field "Rate Limit": "5 posts per hour"
        - Warning: "Keep this key secret. If compromised, run /setup-mcp again."
        - Color: green (0x57F287)

     6. Reply with ephemeral: true

     7. Also DM the user as backup:
        - Try interaction.user.send() with same embed
        - If DM fails (user has DMs disabled), that's okay - they have ephemeral

3. Export setupMcpCommand
  </action>
  <verify>TypeScript compiles. Command structure matches existing commands pattern (help.ts, status.ts).</verify>
  <done>/setup-mcp command generates API key, replies ephemeral, attempts DM backup.</done>
</task>

<task type="auto">
  <name>Task 3: Wire /setup-mcp into bot and update exports</name>
  <files>midl-agent/src/discord/commands/index.ts, midl-agent/src/discord/bot.ts, midl-agent/src/mcp-server/index.ts</files>
  <action>
1. Update `src/discord/commands/index.ts`:
   - Import setupMcpCommand from "./setup-mcp.js"
   - Add to commands array
   - Add to exports

2. Update `src/discord/bot.ts`:
   - Import apiKeyStore from "../mcp-server/api-key-store.js"
   - No other changes needed - setupMcpCommand is already in commands array
   - Note: The bot and MCP server share the apiKeyStore singleton

3. Update `src/mcp-server/index.ts`:
   - Export { ApiKeyStore, apiKeyStore } from "./api-key-store.js"
   - Update McpDiscordServer to accept apiKeyStore in constructor (use singleton as default)

4. Run build to verify everything compiles
  </action>
  <verify>Run `npm run build` succeeds. Commands array includes setupMcpCommand. Bot file imports apiKeyStore.</verify>
  <done>/setup-mcp command registered with bot. apiKeyStore shared between bot and MCP server. All exports updated.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. setupMcpCommand appears in commands array
3. ApiKeyStore has all required methods
4. Rate limiting blocks after 5 posts in the same hour
5. apiKeyStore singleton is exported from mcp-server/index.ts
</verification>

<success_criteria>
- /setup-mcp command generates unique API keys
- Keys are tied to Discord user IDs (one key per user)
- Rate limit of 5 posts/hour enforced
- Key delivered via ephemeral message + DM backup
- apiKeyStore shared between Discord bot and MCP server
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-02-SUMMARY.md`
</output>
