---
phase: 06.1-mcp-server-for-discord-posting
plan: 05
type: execute
wave: 3
depends_on: ["06.1-02", "06.1-03", "06.1-04"]
files_modified:
  - midl-agent/src/mcp-server/server.test.ts
  - midl-agent/src/mcp-server/api-key-store.test.ts
  - midl-agent/.env.example
autonomous: false

must_haves:
  truths:
    - "MCP server tests verify tool behavior"
    - "ApiKeyStore tests verify rate limiting"
    - "End-to-end flow documented for manual testing"
    - ".env.example includes MCP_API_KEY"
  artifacts:
    - path: "midl-agent/src/mcp-server/server.test.ts"
      provides: "Unit tests for MCP server tools"
      min_lines: 50
    - path: "midl-agent/src/mcp-server/api-key-store.test.ts"
      provides: "Unit tests for API key management and rate limiting"
      min_lines: 40
    - path: "midl-agent/.env.example"
      provides: "Environment variable template with MCP_API_KEY"
      contains: "MCP_API_KEY"
  key_links:
    - from: "midl-agent/src/mcp-server/server.test.ts"
      to: "midl-agent/src/mcp-server/server.ts"
      via: "McpDiscordServer import"
      pattern: "import.*McpDiscordServer"
---

<objective>
Add unit tests for MCP server components and verify the complete integration manually.

Purpose: Ensure the MCP server, API key management, and rate limiting work correctly before integration with the main agent distribution.

Output: Test coverage for MCP server, documented manual testing procedure, updated .env.example.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-CONTEXT.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-01-SUMMARY.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-02-SUMMARY.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-03-SUMMARY.md
@.planning/phases/06.1-mcp-server-for-discord-posting/06.1-04-SUMMARY.md
@midl-agent/src/mcp-server/server.ts
@midl-agent/src/mcp-server/api-key-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write ApiKeyStore unit tests</name>
  <files>midl-agent/src/mcp-server/api-key-store.test.ts</files>
  <action>
Create `src/mcp-server/api-key-store.test.ts`:

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { ApiKeyStore } from "./api-key-store.js";

describe("ApiKeyStore", () => {
  let store: ApiKeyStore;

  beforeEach(() => {
    store = new ApiKeyStore();
  });

  describe("createKey", () => {
    it("generates a key starting with midl_", () => {
      const key = store.createKey("user123");
      expect(key).toMatch(/^midl_[a-f0-9]{32}$/);
    });

    it("replaces existing key for same user", () => {
      const key1 = store.createKey("user123");
      const key2 = store.createKey("user123");
      expect(key1).not.toBe(key2);
      expect(store.validateKey(key1)).toBeNull();
      expect(store.validateKey(key2)).not.toBeNull();
    });
  });

  describe("validateKey", () => {
    it("returns record for valid key", () => {
      const key = store.createKey("user123");
      const record = store.validateKey(key);
      expect(record).not.toBeNull();
      expect(record?.discordUserId).toBe("user123");
    });

    it("returns null for invalid key", () => {
      expect(store.validateKey("invalid")).toBeNull();
    });
  });

  describe("checkRateLimit", () => {
    it("allows posts under limit", () => {
      const key = store.createKey("user123");
      const result = store.checkRateLimit(key);
      expect(result.allowed).toBe(true);
      expect(result.remaining).toBe(5);
    });

    it("blocks after 5 posts", () => {
      const key = store.createKey("user123");
      for (let i = 0; i < 5; i++) {
        store.recordPost(key);
      }
      const result = store.checkRateLimit(key);
      expect(result.allowed).toBe(false);
      expect(result.remaining).toBe(0);
    });

    it("decrements remaining after each post", () => {
      const key = store.createKey("user123");
      store.recordPost(key);
      store.recordPost(key);
      const result = store.checkRateLimit(key);
      expect(result.remaining).toBe(3);
    });
  });

  describe("getKeyForUser", () => {
    it("returns existing key for user", () => {
      const key = store.createKey("user123");
      expect(store.getKeyForUser("user123")).toBe(key);
    });

    it("returns null for unknown user", () => {
      expect(store.getKeyForUser("unknown")).toBeNull();
    });
  });

  describe("revokeKey", () => {
    it("removes key from store", () => {
      const key = store.createKey("user123");
      expect(store.revokeKey(key)).toBe(true);
      expect(store.validateKey(key)).toBeNull();
    });

    it("returns false for unknown key", () => {
      expect(store.revokeKey("unknown")).toBe(false);
    });
  });
});
```
  </action>
  <verify>Run `npm test src/mcp-server/api-key-store.test.ts` - all tests pass.</verify>
  <done>ApiKeyStore has comprehensive unit tests for key generation, validation, rate limiting, and revocation.</done>
</task>

<task type="auto">
  <name>Task 2: Write MCP server unit tests</name>
  <files>midl-agent/src/mcp-server/server.test.ts</files>
  <action>
Create `src/mcp-server/server.test.ts`:

Test strategy: Since MCP server uses stdio transport, we can't easily test the full flow. Instead, test the internal methods and tool handlers in isolation.

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";
import { McpDiscordServer } from "./server.js";
import { ApiKeyStore } from "./api-key-store.js";
import type { McpServerConfig } from "./types.js";

// Mock the discord client to avoid actual connections
vi.mock("../discord/discord-client.js", () => ({
  DiscordClient: vi.fn().mockImplementation(() => ({
    connect: vi.fn().mockResolvedValue(undefined),
    disconnect: vi.fn().mockResolvedValue(undefined),
    isConnected: true,
    getForumChannel: vi.fn().mockResolvedValue({
      threads: {
        create: vi.fn().mockResolvedValue({ id: "thread123" }),
      },
    }),
    getConfig: vi.fn().mockReturnValue({
      botToken: "mock",
      guildId: "guild123",
      forumChannelId: "forum123",
    }),
  })),
}));

// Mock forum-poster
vi.mock("../discord/forum-poster.js", () => ({
  ForumPoster: vi.fn().mockImplementation(() => ({
    postReport: vi.fn().mockResolvedValue({
      threadId: "thread123",
      threadUrl: "https://discord.com/channels/guild123/thread123",
    }),
  })),
}));

describe("McpDiscordServer", () => {
  let server: McpDiscordServer;
  let apiKeyStore: ApiKeyStore;
  const mockConfig: McpServerConfig = {
    discordBotToken: "test-token",
    guildId: "test-guild",
    forumChannelId: "test-forum",
  };

  beforeEach(() => {
    apiKeyStore = new ApiKeyStore();
    server = new McpDiscordServer(mockConfig, apiKeyStore);
  });

  describe("API key validation", () => {
    it("rejects requests without valid API key", async () => {
      // The actual tool handlers check API keys
      // This tests the validateKey method indirectly
      const result = apiKeyStore.validateKey("invalid-key");
      expect(result).toBeNull();
    });

    it("accepts requests with valid API key", async () => {
      const key = apiKeyStore.createKey("user123");
      const result = apiKeyStore.validateKey(key);
      expect(result).not.toBeNull();
      expect(result?.discordUserId).toBe("user123");
    });
  });

  describe("rate limiting integration", () => {
    it("blocks after rate limit exceeded", () => {
      const key = apiKeyStore.createKey("user123");

      // Simulate 5 posts
      for (let i = 0; i < 5; i++) {
        const check = apiKeyStore.checkRateLimit(key);
        expect(check.allowed).toBe(true);
        apiKeyStore.recordPost(key);
      }

      // 6th should be blocked
      const finalCheck = apiKeyStore.checkRateLimit(key);
      expect(finalCheck.allowed).toBe(false);
    });
  });
});
```

Note: Full MCP tool testing requires an MCP client. For now, we test the underlying components. Integration testing will be manual.
  </action>
  <verify>Run `npm test src/mcp-server/server.test.ts` - all tests pass.</verify>
  <done>MCP server has unit tests for API key validation and rate limiting integration.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete MCP server for Discord posting with:
- 3 MCP tools (check_server_status, create_discord_thread, list_recent_threads)
- API key generation via /setup-mcp Discord command
- Rate limiting (5 posts/hour per key)
- Thread tracking for duplicate detection
- Agent configuration updated to use MCP
  </what-built>
  <how-to-verify>
**Manual integration test:**

1. Start the Discord bot (which includes /setup-mcp command):
   ```bash
   cd midl-agent
   npm run bot
   ```

2. In Discord server, run `/setup-mcp`
   - Should receive ephemeral message with API key
   - Should receive DM backup with same key

3. Copy the API key and add to .env:
   ```
   MCP_API_KEY=midl_xxxxx...
   ```

4. Verify the MCP server starts:
   ```bash
   npm run mcp-server
   ```
   (Will wait for stdio input - this confirms it starts without errors)

5. Check builds and tests:
   ```bash
   npm run build
   npm test
   ```

**Expected outcomes:**
- /setup-mcp generates unique API key
- MCP server starts on stdio transport
- All tests pass
- No TypeScript errors
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `npm test` passes with new tests
2. ApiKeyStore tests cover all methods
3. Server tests verify API key and rate limit integration
4. Manual test confirms /setup-mcp generates key
5. Manual test confirms MCP server starts
</verification>

<success_criteria>
- ApiKeyStore has >80% test coverage
- MCP server component tests pass
- /setup-mcp command works in Discord
- MCP server starts without errors
- .env.example updated with MCP_API_KEY
- All builds and existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-mcp-server-for-discord-posting/06.1-05-SUMMARY.md`
</output>
