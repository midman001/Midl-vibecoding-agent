---
phase: 06-discord-integration
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - midl-agent/src/discord/commands/report-bug.ts
  - midl-agent/src/discord/commands/index.ts
autonomous: true

must_haves:
  truths:
    - "/report-bug command triggers diagnostic report generation"
    - "Generated report posted to forum channel as new thread"
    - "User sees ephemeral confirmation with thread link"
    - "User can optionally provide their name for attribution"
  artifacts:
    - path: "midl-agent/src/discord/commands/report-bug.ts"
      provides: "/report-bug slash command"
      exports: ["reportBugCommand"]
  key_links:
    - from: "midl-agent/src/discord/commands/report-bug.ts"
      to: "midl-agent/src/discord/forum-poster.ts"
      via: "ForumPoster.postReport()"
      pattern: "forumPoster\\.postReport"
    - from: "midl-agent/src/discord/commands/report-bug.ts"
      to: "midl-agent/src/search/workflow-orchestrator.ts"
      via: "WorkflowOrchestrator.handleProblemReport()"
      pattern: "handleProblemReport"
---

<objective>
Create /report-bug slash command that generates a diagnostic report and posts it to the Discord forum channel.

Purpose: Primary user-facing feature - users trigger diagnostic report generation and get it posted to Discord.
Output: Working /report-bug command that generates report, posts to forum, returns thread link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-discord-integration/06-01-SUMMARY.md
@.planning/phases/06-discord-integration/06-02-SUMMARY.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/src/search/diagnostic-report-generator.ts
@midl-agent/src/discord/forum-poster.ts
@midl-agent/src/discord/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /report-bug slash command</name>
  <files>midl-agent/src/discord/commands/report-bug.ts, midl-agent/src/discord/commands/index.ts</files>
  <action>
    Create `commands/report-bug.ts`:
    - Slash command with options:
      - `description` (string, required): Brief description of the problem
      - `error-message` (string, optional): The error message encountered
      - `sdk-package` (string, optional): Which MIDL SDK package (choices: @midl/core, @midl/react, @midl/contracts, @midl/executor-react)
      - `network` (string, optional): Which network (choices: mainnet, testnet, devnet)
      - `your-name` (string, optional): Name for attribution in the forum post

    - Execute flow:
      1. Defer reply (ephemeral) since report generation takes a moment: `interaction.deferReply({ ephemeral: true })`
      2. Build `Partial<DiagnosticContext>` from command options:
         - `userDescription` from description option
         - `errorMessages` from error-message option (wrap in array)
         - `environment.network` from network option
         - `environment.sdkPackages` from sdk-package option
      3. Call `WorkflowOrchestrator.handleProblemReport()` to generate report
      4. If diagnosticReport exists in result, call `ForumPoster.postReport()` with:
         - title: first 100 chars of description
         - summary: result.formattedResponse (or a shorter version)
         - reportMarkdown: diagnosticReport.markdown
         - reportFilename: generated filename from DiagnosticReportGenerator
         - authorName: from your-name option
      5. Edit deferred reply with ephemeral success embed:
         - "Report posted!" with thread link
         - Color: green
      6. If no diagnosticReport (shouldn't happen but defensive): reply with report text in ephemeral message

    - The command needs ForumPoster and WorkflowOrchestrator instances. Accept them via a factory/setup function: `createReportBugCommand(orchestrator, forumPoster)` that returns the SlashCommand object. This keeps DI consistent.

    - Update `commands/index.ts` to include reportBugCommand (note: it needs special setup, so export it separately or document that it needs factory call)
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>/report-bug command generates diagnostic report from user input, posts to forum, returns ephemeral confirmation with thread link</done>
</task>

<task type="auto">
  <name>Task 2: Add report-bug command tests</name>
  <files>midl-agent/src/discord/commands/report-bug.test.ts</files>
  <action>
    Test /report-bug command:
    - Mock WorkflowOrchestrator.handleProblemReport to return canned WorkflowResult with diagnosticReport
    - Mock ForumPoster.postReport to return canned threadId/threadUrl
    - Mock interaction with deferReply, editReply, options.getString spies
    - Test cases:
      1. Calls deferReply with ephemeral: true
      2. Passes description to handleProblemReport
      3. Calls forumPoster.postReport with correct title, markdown, filename
      4. Includes authorName when your-name option provided
      5. Omits authorName when your-name option not provided
      6. editReply contains thread URL on success
      7. editReply contains error message when postReport throws
      8. Builds DiagnosticContext with error-message when provided
      9. Builds DiagnosticContext with network when provided
  </action>
  <verify>`npx vitest run src/discord/commands/report-bug.test.ts` passes</verify>
  <done>All report-bug tests pass, verifying full flow from command options through report generation to forum posting</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run src/discord/commands/report-bug.test.ts` passes
- /report-bug command properly wires WorkflowOrchestrator to ForumPoster
</verification>

<success_criteria>
/report-bug command accepts problem details, generates diagnostic report via WorkflowOrchestrator, posts to Discord forum via ForumPoster, returns ephemeral confirmation with thread link. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/06-discord-integration/06-04-SUMMARY.md`
</output>
