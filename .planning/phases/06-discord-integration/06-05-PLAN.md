---
phase: 06-discord-integration
plan: 05
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - midl-agent/src/discord/bot.ts
  - midl-agent/src/discord/index.ts
  - midl-agent/src/search/workflow-orchestrator.ts
  - midl-agent/claude.json
  - midl-agent/system-prompt.md
  - midl-agent/bug-report-workflow.md
autonomous: true

must_haves:
  truths:
    - "Bot startup script initializes client, registers commands, and listens for interactions"
    - "WorkflowOrchestrator offers Discord posting after generating reports"
    - "Agent prompts mention Discord integration and /report-bug command"
    - "Bot can be started with a single entry point"
  artifacts:
    - path: "midl-agent/src/discord/bot.ts"
      provides: "Bot startup and lifecycle management"
      exports: ["startBot", "stopBot"]
    - path: "midl-agent/src/discord/index.ts"
      provides: "Barrel export for discord module"
      exports: ["DiscordClient", "ForumPoster", "CommandHandler", "startBot"]
  key_links:
    - from: "midl-agent/src/discord/bot.ts"
      to: "midl-agent/src/discord/discord-client.ts"
      via: "DiscordClient.connect()"
      pattern: "client\\.connect"
    - from: "midl-agent/src/discord/bot.ts"
      to: "midl-agent/src/discord/command-handler.ts"
      via: "CommandHandler.registerCommands()"
      pattern: "registerCommands"
    - from: "midl-agent/src/search/workflow-orchestrator.ts"
      to: "midl-agent/src/discord/forum-poster.ts"
      via: "optional ForumPoster dependency"
      pattern: "forumPoster"
---

<objective>
Create bot entry point, wire Discord posting into WorkflowOrchestrator, and update agent configuration/prompts.

Purpose: Final integration - bot runs as a service, orchestrator can post to Discord, agent knows about Discord features.
Output: Complete working Discord bot with all features connected, updated agent prompts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-discord-integration/06-01-SUMMARY.md
@.planning/phases/06-discord-integration/06-02-SUMMARY.md
@.planning/phases/06-discord-integration/06-03-SUMMARY.md
@.planning/phases/06-discord-integration/06-04-SUMMARY.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/src/discord/discord-client.ts
@midl-agent/src/discord/command-handler.ts
@midl-agent/src/discord/forum-poster.ts
@midl-agent/claude.json
@midl-agent/system-prompt.md
@midl-agent/bug-report-workflow.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bot entry point and barrel export</name>
  <files>midl-agent/src/discord/bot.ts, midl-agent/src/discord/index.ts</files>
  <action>
    1. Create `src/discord/bot.ts`:
       - `startBot()` async function:
         a. Load config via loadDiscordConfig()
         b. Create DiscordClient
         c. Create WorkflowOrchestrator
         d. Create ForumPoster with client
         e. Create CommandHandler with client (pass orchestrator and forumPoster for /report-bug)
         f. Connect client
         g. Register slash commands
         h. Set up interactionCreate event listener -> commandHandler.handleInteraction()
         i. Set up graceful shutdown on SIGINT/SIGTERM -> stopBot()
         j. Log "MIDL Discord bot is running!"
         k. Return cleanup function
       - `stopBot(client: DiscordClient)` function: disconnect client, log shutdown
       - If run directly (`process.argv[1]` check or similar): call startBot()
       - Add `"bot": "npx tsx src/discord/bot.ts"` script to package.json

    2. Create `src/discord/index.ts` barrel:
       - Export DiscordClient, ForumPoster, CommandHandler, startBot, stopBot
       - Export types: DiscordConfig, ForumPostOptions
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Bot can be started with `npm run bot`, initializes all Discord components, handles graceful shutdown</done>
</task>

<task type="auto">
  <name>Task 2: Wire Discord into WorkflowOrchestrator and update agent config</name>
  <files>midl-agent/src/search/workflow-orchestrator.ts, midl-agent/claude.json, midl-agent/system-prompt.md, midl-agent/bug-report-workflow.md</files>
  <action>
    1. Update `WorkflowOrchestrator`:
       - Add optional `ForumPoster` to constructor deps
       - Add `postToDiscord(diagnosticReport, options: { title: string, authorName?: string }): Promise<{ threadUrl: string } | null>` method:
         - If no forumPoster configured, return null
         - Call forumPoster.postReport with report data
         - Return threadUrl on success, null on error (log error, don't throw)
       - Update `formatReportDraftResponse` to mention Discord posting option:
         - Add line: "Want to share this on Discord? I can post it to the MIDL support forum for you."
       - Keep existing tests passing - ForumPoster is optional so no breaking changes

    2. Update `claude.json`:
       - Add "discord" command: description "Manage Discord bot and forum posting", keywords ["discord", "post", "share", "forum"]
       - Add "Discord bot with slash commands and forum posting" to capabilities
       - Add discord feature flag: `"discordIntegration": true`

    3. Update `system-prompt.md`:
       - Add section about Discord integration capabilities
       - Mention /report-bug, /help, /status, /links, /networks commands
       - Note that diagnostic reports can be posted to Discord forum
       - Describe the "post to Discord?" prompt flow after report generation

    4. Update `bug-report-workflow.md`:
       - Add Discord posting step after report generation
       - Flow: generate report -> show to user -> ask "Post to Discord?" -> if yes, post and share thread link
  </action>
  <verify>`npx tsc --noEmit` passes. `npx vitest run src/search/workflow-orchestrator.test.ts` passes (no breaking changes).</verify>
  <done>WorkflowOrchestrator has optional Discord posting, agent config/prompts updated with Discord features, existing tests still pass</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run` all tests pass
- bot.ts can be invoked as entry point
- claude.json has discord command and capability
- system-prompt.md mentions Discord features
- WorkflowOrchestrator.postToDiscord method exists
</verification>

<success_criteria>
Bot runs from single entry point, WorkflowOrchestrator can optionally post reports to Discord, agent prompts describe Discord integration, all existing tests still pass.
</success_criteria>

<output>
After completion, create `.planning/phases/06-discord-integration/06-05-SUMMARY.md`
</output>
