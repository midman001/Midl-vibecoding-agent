---
phase: 06-discord-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/package.json
  - midl-agent/src/discord/discord-client.ts
  - midl-agent/src/discord/types.ts
  - midl-agent/.env.example
autonomous: true

must_haves:
  truths:
    - "Discord bot connects to Discord gateway and comes online"
    - "Bot configuration loaded from environment variables"
    - "DiscordClient class provides typed interface for bot operations"
  artifacts:
    - path: "midl-agent/src/discord/discord-client.ts"
      provides: "DiscordClient wrapper class"
      exports: ["DiscordClient"]
    - path: "midl-agent/src/discord/types.ts"
      provides: "Discord config and shared types"
      exports: ["DiscordConfig", "ForumPostOptions"]
    - path: "midl-agent/.env.example"
      provides: "Environment variable template"
      contains: "DISCORD_BOT_TOKEN"
  key_links:
    - from: "midl-agent/src/discord/discord-client.ts"
      to: "discord.js Client"
      via: "constructor initialization"
      pattern: "new Client"
---

<objective>
Install discord.js, create DiscordClient wrapper class, and define Discord configuration types.

Purpose: Foundation for all Discord features - bot connection, config loading, typed interfaces.
Output: Working DiscordClient that can connect to Discord, plus .env.example template.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@midl-agent/package.json
@midl-agent/tsconfig.json
@midl-agent/src/search/workflow-orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install discord.js and create Discord types</name>
  <files>midl-agent/package.json, midl-agent/src/discord/types.ts, midl-agent/.env.example</files>
  <action>
    1. Install discord.js: `npm install discord.js` in midl-agent/
    2. Create `src/discord/types.ts` with:
       - `DiscordConfig` interface: `botToken: string`, `guildId: string`, `forumChannelId: string`
       - `ForumPostOptions` interface: `title: string`, `summary: string`, `reportMarkdown: string`, `reportFilename: string`, `authorName?: string`
       - `RateLimitConfig` interface: `maxRequestsPerMinute: number` (default 10), `cooldownMs: number` (default 60000)
       - `loadDiscordConfig()` function that reads from `process.env.DISCORD_BOT_TOKEN`, `process.env.DISCORD_GUILD_ID`, `process.env.DISCORD_FORUM_CHANNEL_ID` - throws clear error if any missing
    3. Create/update `.env.example` with Discord vars:
       ```
       # Discord Bot Configuration
       DISCORD_BOT_TOKEN=your-bot-token-here
       DISCORD_GUILD_ID=your-guild-id-here
       DISCORD_FORUM_CHANNEL_ID=your-forum-channel-id-here
       ```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` in midl-agent/</verify>
  <done>DiscordConfig type exists, loadDiscordConfig reads env vars, .env.example has all Discord vars</done>
</task>

<task type="auto">
  <name>Task 2: Create DiscordClient wrapper class</name>
  <files>midl-agent/src/discord/discord-client.ts</files>
  <action>
    Create `src/discord/discord-client.ts` with DiscordClient class:
    - Constructor accepts optional `DiscordConfig` (defaults to `loadDiscordConfig()`)
    - Constructor DI pattern consistent with rest of codebase (optional deps object)
    - Uses discord.js `Client` with intents: `Guilds`, `GuildMessages`
    - `connect()` method: logs in with bot token, resolves when ready event fires, logs "Discord bot connected as {tag}"
    - `disconnect()` method: calls client.destroy()
    - `isConnected()` getter: returns boolean based on client.isReady()
    - `getGuild()` method: returns guild by guildId from config
    - `getForumChannel()` method: gets forum channel by forumChannelId, throws if not a ForumChannel type
    - Rate limiting: simple token bucket with configurable max requests/minute (default 10). `checkRateLimit()` throws if exceeded. Apply to public methods that hit Discord API.
    - Export the class and a convenience `createDiscordClient()` factory function
  </action>
  <verify>`npx tsc --noEmit` passes. Manually verify class structure is sound.</verify>
  <done>DiscordClient class exists with connect/disconnect/getGuild/getForumChannel methods, rate limiting built in</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in midl-agent/
- discord.js appears in package.json dependencies
- .env.example contains all three Discord env vars
- DiscordClient exports connect, disconnect, isConnected, getGuild, getForumChannel
</verification>

<success_criteria>
Discord.js installed, DiscordClient wrapper provides typed interface for bot operations with rate limiting, config loads from environment variables.
</success_criteria>

<output>
After completion, create `.planning/phases/06-discord-integration/06-01-SUMMARY.md`
</output>
