---
phase: 06-discord-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/discord/forum-poster.ts
autonomous: true

must_haves:
  truths:
    - "Diagnostic report can be posted to Discord forum channel as new thread"
    - "Thread contains friendly summary message plus .md file attachment"
    - "Author name mentioned in thread if provided"
  artifacts:
    - path: "midl-agent/src/discord/forum-poster.ts"
      provides: "ForumPoster class for creating forum threads with diagnostic reports"
      exports: ["ForumPoster"]
  key_links:
    - from: "midl-agent/src/discord/forum-poster.ts"
      to: "discord.js ForumChannel"
      via: "threads.create"
      pattern: "threads\\.create"
---

<objective>
Create ForumPoster class that posts diagnostic reports to Discord forum channel as new threads.

Purpose: Core Discord output - users share diagnostic reports with the MIDL community.
Output: ForumPoster class that creates forum threads with summary + .md attachment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@midl-agent/src/search/diagnostic-report-generator.ts
@.planning/phases/06-discord-integration/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ForumPoster class</name>
  <files>midl-agent/src/discord/forum-poster.ts</files>
  <action>
    Create `src/discord/forum-poster.ts`:
    - Constructor accepts `DiscordClient` instance (DI pattern)
    - `postReport(options: ForumPostOptions): Promise<{ threadId: string; threadUrl: string }>` method:
      1. Get forum channel via `discordClient.getForumChannel()`
      2. Build summary message in cool, friendly Discord tone:
         - Start with something like "Hey team! Got a new bug report coming in"
         - If `authorName` provided: "from {authorName}"
         - Include brief human-friendly overview of the issue (from title)
         - End with "Full diagnostic details in the attached file"
      3. Create thread via `forumChannel.threads.create()`:
         - `name`: options.title (truncated to 100 chars for Discord limit)
         - `message.content`: the friendly summary
         - `message.files`: attach reportMarkdown as Buffer with reportFilename
      4. Return `{ threadId: thread.id, threadUrl }` where threadUrl is constructed from guild/channel/thread IDs
    - `formatSummaryMessage(options: ForumPostOptions): string` - public for testing. Writes in approachable, helpful tone. Not corporate.
    - Error handling: catch Discord API errors and throw with clear message ("Failed to create forum thread: {reason}")
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>ForumPoster creates forum threads with friendly summary + .md file attachment, returns thread URL</done>
</task>

<task type="auto">
  <name>Task 2: Create ForumPoster tests</name>
  <files>midl-agent/src/discord/forum-poster.test.ts</files>
  <action>
    Create tests for ForumPoster:
    - Mock DiscordClient with mock getForumChannel() returning a mock ForumChannel
    - Mock ForumChannel.threads.create to capture arguments and return mock thread
    - Test cases:
      1. Creates thread with correct title, summary, and file attachment
      2. Truncates title to 100 chars when too long
      3. Includes authorName in summary when provided
      4. Omits authorName mention when not provided
      5. Throws descriptive error when forum channel not found
      6. Summary message has friendly tone (assert does NOT contain corporate phrases like "Please find attached")
    - Use vitest mocking
  </action>
  <verify>`npx vitest run src/discord/forum-poster.test.ts` passes</verify>
  <done>All ForumPoster tests pass, verifying thread creation, title truncation, author mention, error handling</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run src/discord/forum-poster.test.ts` passes
- ForumPoster exports postReport method returning threadId and threadUrl
</verification>

<success_criteria>
ForumPoster class creates Discord forum threads with friendly summary messages and .md file attachments. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/06-discord-integration/06-02-SUMMARY.md`
</output>
