---
phase: 02-search-duplicate-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/types/search-types.ts
  - midl-agent/src/search/github-client.ts
  - midl-agent/src/search/term-extractor.ts
  - midl-agent/src/search/issue-searcher.ts
autonomous: true

must_haves:
  truths:
    - "GitHubClient works without a token (unauthenticated mode)"
    - "Agent extracts meaningful search terms from a user's problem description"
    - "Agent queries GitHub and returns top 5 matching issues"
    - "Search completes within 5 seconds (timeout enforced)"
  artifacts:
    - path: "midl-agent/src/search/term-extractor.ts"
      provides: "Search term extraction from natural language"
      exports: ["SearchTermExtractor"]
    - path: "midl-agent/src/search/issue-searcher.ts"
      provides: "Orchestrates search: extract terms -> query GitHub -> return results"
      exports: ["IssueSearcher"]
    - path: "midl-agent/src/types/search-types.ts"
      provides: "Updated types with optional token and search result types"
      contains: "SearchResult"
  key_links:
    - from: "midl-agent/src/search/issue-searcher.ts"
      to: "midl-agent/src/search/term-extractor.ts"
      via: "imports and calls extractTerms"
      pattern: "extractTerms"
    - from: "midl-agent/src/search/issue-searcher.ts"
      to: "midl-agent/src/search/github-client.ts"
      via: "calls searchIssues with extracted terms"
      pattern: "searchIssues"
---

<objective>
Make GitHub token optional, build search term extraction, and create the IssueSearcher that orchestrates end-to-end issue search from a user's problem description.

Purpose: This is the core search pipeline -- user describes a problem, agent finds matching issues.
Output: IssueSearcher class that accepts a problem description and returns ranked GitHub issues.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-github-api-foundation/01-01-SUMMARY.md
@midl-agent/src/search/github-client.ts
@midl-agent/src/types/search-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make GitHub token optional and update types</name>
  <files>midl-agent/src/types/search-types.ts, midl-agent/src/search/github-client.ts</files>
  <action>
    1. In search-types.ts:
       - Change `token: string` to `token?: string` in GitHubClientConfig
       - Make `owner` and `repo` optional too (they have defaults): `owner?: string; repo?: string`
       - Add new types:
         ```typescript
         export interface SearchResult {
           issue: GitHubIssueResult;
           similarityScore: number; // 0-1, populated later by scorer
         }

         export interface SearchOptions {
           limit?: number;           // default 5
           includeClosedIssues?: boolean; // default true for duplicate detection
           timeoutMs?: number;       // default 5000
         }
         ```

    2. In github-client.ts:
       - Remove the token validation that throws ("GitHub token is required...").
       - When no token provided: create Octokit without auth (`new Octokit()`) -- this gives 60 req/hr unauthenticated.
       - When no token: log a warning via console.warn: "No GitHub token provided. Using unauthenticated mode (60 requests/hour). Set GITHUB_TOKEN for better rate limits."
       - Keep all other behavior identical.

    3. Update the existing test file (github-client.test.ts): the test "throws error if token is missing" should be updated to verify it creates successfully without token and logs a warning instead.
  </action>
  <verify>Run `cd midl-agent && npx vitest run` -- all tests pass including updated token test.</verify>
  <done>GitHubClient creates successfully with no token, warns about rate limits. All existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Search term extractor and IssueSearcher</name>
  <files>midl-agent/src/search/term-extractor.ts, midl-agent/src/search/issue-searcher.ts</files>
  <action>
    1. Create term-extractor.ts with a SearchTermExtractor class:
       - Method: `extractTerms(description: string): string[]`
       - Strategy (simple keyword extraction, NOT ML):
         a. Lowercase the input
         b. Remove common stop words (the, a, an, is, are, was, were, i, my, it, this, that, when, how, do, does, did, not, no, but, or, and, to, of, in, for, on, with, at, from, have, has, had, be, been, can, will, would, should, could, get, got)
         c. Remove punctuation except hyphens (keep compound words like "type-error")
         d. Remove words shorter than 3 characters
         e. Deduplicate
         f. Return top 8 terms (most specific first -- longer words first as a heuristic for specificity)
       - Method: `buildSearchQuery(terms: string[]): string`
         - Joins terms with spaces (GitHub search API uses implicit AND)
         - If more than 5 terms, take top 5 (GitHub search query length limits)

    2. Create issue-searcher.ts with an IssueSearcher class:
       - Constructor: accepts `{ client?: GitHubClient, extractor?: SearchTermExtractor }` (DI pattern)
       - If no client provided, create one with default config (no token)
       - If no extractor provided, create default SearchTermExtractor
       - Method: `async search(description: string, options?: SearchOptions): Promise<SearchResult[]>`
         a. Extract terms from description using extractor
         b. Build search query from terms
         c. Call client.searchIssues with the query
         d. Wrap results as SearchResult[] with similarityScore: 0 (scorer fills this in later)
         e. Enforce timeout: wrap the GitHub call in a Promise.race with setTimeout. If timeout (default 5000ms), return empty array and log warning.
         f. Return top N results (options.limit, default 5)

    Follow the DI pattern from Phase 1 (constructor accepts optional dependencies).
  </action>
  <verify>Run `cd midl-agent && npx vitest run` -- all tests pass. Manually verify files exist and export correctly: `cd midl-agent && npx tsc --noEmit`.</verify>
  <done>SearchTermExtractor extracts keywords from natural language. IssueSearcher orchestrates the full search pipeline with 5-second timeout. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `cd midl-agent && npx tsc --noEmit` compiles with zero errors
- `cd midl-agent && npx vitest run` all tests pass
- GitHubClient can be constructed with no token (no throw)
- SearchTermExtractor removes stop words and returns relevant terms
- IssueSearcher.search() returns SearchResult[] from a description string
</verification>

<success_criteria>
- SEARCH-01: IssueSearcher.search() exists and queries GitHub from a description
- SEARCH-02: SearchTermExtractor extracts terms from user descriptions
- SEARCH-03: GitHubClient queries midl-xyz/midl-js by default
- SEARCH-04: Returns top 5 results (default limit)
- SEARCH-15: 5-second timeout enforced via Promise.race
- Token optional: GitHubClient works without token, warns about rate limits
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-duplicate-detection/02-01-SUMMARY.md`
</output>
