---
phase: 04-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/search/workflow-orchestrator.test.ts
  - midl-agent/src/search/github-client.test.ts
  - midl-agent/src/search/issue-searcher.test.ts
autonomous: true

must_haves:
  truths:
    - "WorkflowOrchestrator integration test validates full flow: search -> extract solutions -> score -> format response"
    - "WorkflowOrchestrator test validates graceful degradation when search fails"
    - "WorkflowOrchestrator test validates report draft generation when no solutions found"
    - "Search timeout handling is explicitly tested"
    - "Rate limit edge cases are explicitly tested"
    - "Duplicate detection accuracy is validated with known duplicate/non-duplicate pairs"
  artifacts:
    - path: "midl-agent/src/search/workflow-orchestrator.test.ts"
      provides: "Integration tests for full workflow + edge cases"
      min_lines: 100
  key_links:
    - from: "midl-agent/src/search/workflow-orchestrator.test.ts"
      to: "midl-agent/src/search/workflow-orchestrator.ts"
      via: "constructor DI with mocked dependencies"
      pattern: "new WorkflowOrchestrator.*duplicateDetector"
---

<objective>
Add integration tests for WorkflowOrchestrator and fill remaining edge case gaps (timeout, rate limit, duplicate accuracy).

Purpose: Close TEST-04 (integration test for bug report with search), TEST-07 (duplicate detection accuracy), TEST-08 (timeout handling), TEST-09 (rate limit handling), and verify TEST-05 (>85% coverage).
Output: WorkflowOrchestrator test file, enhanced existing tests, coverage report.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/src/search/github-client.ts
@midl-agent/src/search/issue-searcher.ts
@midl-agent/src/search/duplicate-detector.ts
@midl-agent/src/types/search-types.ts
@midl-agent/src/search/github-client.test.ts
@midl-agent/src/search/issue-searcher.test.ts
@midl-agent/src/search/duplicate-detector.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkflowOrchestrator integration tests</name>
  <files>
    midl-agent/src/search/workflow-orchestrator.test.ts
  </files>
  <action>
    Create `workflow-orchestrator.test.ts` using constructor DI to inject mock dependencies.

    Build mock objects for each dependency:
    - `mockDuplicateDetector` with `detect` returning configurable results
    - `mockSolutionExtractor` with `extract` returning solutions array
    - `mockApplicabilityScorer` with `scoreApplicability` returning scored results
    - `mockReportGenerator` with `generate` and `formatAsMarkdown`
    - `mockIssueCreator` with `createFromDraft`
    - `mockFixImplementer` with `locateAndPrepareFix`
    - `mockGithubClient` with `getIssueComments`

    Test `handleProblemReport`:
    1. **Happy path with solutions:** detect returns results with comments > 0, extractor returns solutions, scorer returns "very likely" results. Assert: `hasSolutions: true`, `formattedResponse` contains solution text, `reportDraft` is null.

    2. **No solutions found:** detect returns results but extractor returns empty. Assert: `hasSolutions: false`, `reportDraft` is not null, `formattedResponse` contains "didn't find an existing solution".

    3. **Search fails gracefully:** detect throws Error. Assert: `searchPerformed: false`, `duplicatesFound: null`, `reportDraft` is not null (falls through to report generation).

    4. **Comment fetch fails gracefully:** detect returns results, but githubClient.getIssueComments throws. Assert: solutions array empty, falls through to report generation.

    5. **Context extraction from description:** Pass description with "Error: timeout exceeded" and "@midl/react 1.2.3" and "testnet" and "broadcastTransaction". Verify the mock scorer receives correct userContext with all fields populated.

    Test `submitReport`:
    - Delegates to issueCreator.createFromDraft with correct args

    Test `implementSolution`:
    - Delegates to fixImplementer.locateAndPrepareFix with correct args
  </action>
  <verify>Run `cd midl-agent && npx vitest run workflow-orchestrator` — all tests pass.</verify>
  <done>WorkflowOrchestrator has integration tests covering: happy path with solutions, no solutions -> report draft, search failure graceful degradation, comment fetch failure, context extraction, submitReport delegation, implementSolution delegation.</done>
</task>

<task type="auto">
  <name>Task 2: Edge case tests for timeout, rate limits, and duplicate accuracy</name>
  <files>
    midl-agent/src/search/github-client.test.ts
    midl-agent/src/search/issue-searcher.test.ts
    midl-agent/src/search/duplicate-detector.test.ts
  </files>
  <action>
    Add targeted edge case tests to existing test files:

    **github-client.test.ts** - Add tests:
    - `handles network timeout (rejects after delay)`: Mock octokit.rest.search.issuesAndPullRequests to return a promise that never resolves, verify the client handles it (or document that timeout is handled at IssueSearcher level).
    - `handles rate limit with 0 remaining`: Mock response headers showing 0 remaining, verify client logs warning and still returns results.
    - `handles 403 rate limit response`: Mock 403 with rate limit message, verify appropriate error.

    **issue-searcher.test.ts** - Add tests:
    - `respects timeout option`: Pass `timeoutMs: 1` with a delayed mock search, verify it returns empty array (Promise.race timeout behavior).
    - `handles empty search terms gracefully`: Pass empty string, verify returns empty results without API call.

    **duplicate-detector.test.ts** - Add accuracy validation tests:
    - `known duplicate pair scores above threshold`: Create two issues with nearly identical titles/bodies (e.g., "broadcastTransaction timeout on testnet" vs "Transaction broadcast times out on testnet network"), verify similarity > 0.75.
    - `known non-duplicate pair scores below threshold`: Create two issues with unrelated content (e.g., "broadcastTransaction timeout" vs "CSS styling issue in dashboard"), verify similarity < 0.75.
    - `handles zero results without error`: Empty results array returns `hasDuplicates: false`.

    Run full test suite with coverage at the end:
    ```bash
    cd midl-agent && npx vitest run --coverage
    ```
    Verify coverage is >85% on src/search/*.ts files. If not, identify gaps and add targeted tests.
  </action>
  <verify>Run `cd midl-agent && npx vitest run --coverage` — all tests pass, coverage >85% on new code.</verify>
  <done>Timeout handling tested (TEST-08), rate limit edge cases tested (TEST-09), duplicate detection accuracy validated with known pairs (TEST-07), overall coverage >85% (TEST-05).</done>
</task>

</tasks>

<verification>
```bash
cd midl-agent && npx vitest run --coverage
```
All tests pass. Coverage report shows >85% on src/search/*.ts files.
</verification>

<success_criteria>
- workflow-orchestrator.test.ts created with 7+ test cases
- Existing test files enhanced with edge case tests
- All tests pass (no regressions)
- Coverage >85% on src/search/ code
- TEST-04, TEST-05, TEST-07, TEST-08, TEST-09 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing/04-02-SUMMARY.md`
</output>
