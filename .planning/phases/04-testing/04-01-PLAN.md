---
phase: 04-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/search/term-extractor.test.ts
  - midl-agent/src/search/search-config.test.ts
  - midl-agent/src/search/fix-implementer.test.ts
  - midl-agent/vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "SearchTermExtractor unit tests validate term extraction, stop word filtering, length sorting, and query building"
    - "loadSearchConfig unit tests validate default config, file loading, partial overrides, missing file fallback, and malformed JSON fallback"
    - "FixImplementer unit tests validate no-snippet path, no-identifiers path, no-match path, multi-match path, single-match diff generation, and applyFix write"
    - "Coverage reporting is enabled in vitest config"
  artifacts:
    - path: "midl-agent/src/search/term-extractor.test.ts"
      provides: "Unit tests for SearchTermExtractor"
      min_lines: 40
    - path: "midl-agent/src/search/search-config.test.ts"
      provides: "Unit tests for loadSearchConfig"
      min_lines: 50
    - path: "midl-agent/src/search/fix-implementer.test.ts"
      provides: "Unit tests for FixImplementer"
      min_lines: 80
  key_links:
    - from: "midl-agent/src/search/fix-implementer.test.ts"
      to: "midl-agent/src/search/fix-implementer.ts"
      via: "import and mock fs dependency injection"
      pattern: "new FixImplementer.*fs"
    - from: "midl-agent/src/search/search-config.test.ts"
      to: "midl-agent/src/search/search-config.ts"
      via: "import loadSearchConfig and mock fs"
      pattern: "loadSearchConfig"
---

<objective>
Add unit tests for the three untested modules (SearchTermExtractor, loadSearchConfig, FixImplementer) and enable coverage reporting.

Purpose: Close TEST-01 gaps (searcher unit tests include term extraction), TEST-06 (mock GitHub API - extend to fs mocking), and set up TEST-05 (coverage measurement).
Output: Three new test files and updated vitest config with coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@midl-agent/src/search/term-extractor.ts
@midl-agent/src/search/search-config.ts
@midl-agent/src/search/fix-implementer.ts
@midl-agent/src/types/search-types.ts
@midl-agent/vitest.config.ts
@midl-agent/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for SearchTermExtractor and loadSearchConfig</name>
  <files>
    midl-agent/src/search/term-extractor.test.ts
    midl-agent/src/search/search-config.test.ts
    midl-agent/vitest.config.ts
  </files>
  <action>
    1. Update `vitest.config.ts` to add coverage configuration:
       - Add `coverage: { provider: 'v8', reporter: ['text', 'text-summary'], include: ['src/**/*.ts'], exclude: ['src/**/*.test.ts'] }` inside the `test` object.

    2. Create `term-extractor.test.ts` with tests for `SearchTermExtractor`:
       - `extractTerms` removes stop words (test with "the error is in the code" -> no "the", "is", "in")
       - `extractTerms` filters words shorter than 3 chars
       - `extractTerms` lowercases input
       - `extractTerms` removes punctuation/special chars
       - `extractTerms` deduplicates
       - `extractTerms` sorts by length descending (longer = more specific)
       - `extractTerms` returns max 8 terms
       - `buildSearchQuery` joins first 5 terms with spaces
       - `buildSearchQuery` with fewer than 5 terms returns all

    3. Create `search-config.test.ts` with tests for `loadSearchConfig`:
       - Returns DEFAULT_SEARCH_CONFIG when no path provided
       - Returns DEFAULT_SEARCH_CONFIG when file doesn't exist
       - Parses valid JSON and merges with defaults (use vi.mock('node:fs') to mock existsSync/readFileSync)
       - Partial config merges with defaults (e.g., only duplicateThreshold specified)
       - Malformed JSON returns defaults and calls console.warn
       - Nested applicabilityWeights partial merge works (override errorMessage, keep others)
  </action>
  <verify>Run `cd midl-agent && npx vitest run term-extractor search-config` — all tests pass.</verify>
  <done>SearchTermExtractor and loadSearchConfig have comprehensive unit tests covering happy path, edge cases, and error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for FixImplementer</name>
  <files>
    midl-agent/src/search/fix-implementer.test.ts
  </files>
  <action>
    Create `fix-implementer.test.ts` testing `FixImplementer` using constructor DI for fs:

    Build a mock fs object that implements readFileSync, writeFileSync, existsSync, readdirSync (returning Dirent-like objects). Pass via `new FixImplementer({ fs: mockFs })`.

    Test `locateAndPrepareFix`:
    - Solution with no codeSnippet returns `applied: false` with explanation
    - Solution with codeSnippet but no extractable identifiers returns error
    - Solution with identifiers but no matching files returns error mentioning identifiers
    - Solution matching multiple files returns `candidates` array
    - Solution matching exactly one file returns `diff` string and `filePath`
    - Diff output contains the code snippet and file path

    Test `applyFix`:
    - Successful write returns `{ success: true }`
    - writeFileSync throwing returns `{ success: false, error: ... }`

    Test `extractIdentifiers` (indirectly through locateAndPrepareFix):
    - Code with `import { Foo } from ...` extracts "Foo"
    - Code with `bar.baz()` extracts "bar", "baz"
    - Common keywords (if, for, while) are NOT extracted

    For the mock fs, create a simple in-memory filesystem:
    ```typescript
    const files: Record<string, string> = { '/project/src/app.ts': 'import { broadcastTransaction } from "@midl/sdk";\nbroadcastTransaction({ timeout: 5000 });' };
    const mockFs = {
      readFileSync: (p: string) => { if (files[p]) return files[p]; throw new Error('ENOENT'); },
      writeFileSync: vi.fn(),
      existsSync: (p: string) => p in files,
      readdirSync: (dir: string, opts: any) => // return Dirent-like objects for files in that dir
    };
    ```
  </action>
  <verify>Run `cd midl-agent && npx vitest run fix-implementer` — all tests pass.</verify>
  <done>FixImplementer has unit tests for all code paths: no-snippet, no-identifiers, no-match, multi-match, single-match diff, applyFix success/failure.</done>
</task>

</tasks>

<verification>
```bash
cd midl-agent && npx vitest run
```
All existing + new tests pass. No regressions.
</verification>

<success_criteria>
- 3 new test files created and passing
- vitest.config.ts updated with coverage settings
- All 65+ existing tests still pass
- New tests cover all branches of term-extractor, search-config, and fix-implementer
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing/04-01-SUMMARY.md`
</output>
