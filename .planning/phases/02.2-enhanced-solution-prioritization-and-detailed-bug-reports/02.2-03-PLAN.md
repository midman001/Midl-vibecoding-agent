---
phase: 02.2-enhanced-solution-prioritization-and-detailed-bug-reports
plan: 03
type: execute
wave: 2
depends_on: ["02.2-01", "02.2-02"]
files_modified:
  - midl-agent/src/search/workflow-orchestrator.ts
  - midl-agent/src/search/issue-creator.ts
  - midl-agent/src/search/github-client.ts
autonomous: true

must_haves:
  truths:
    - "Official solutions display '✓ OFFICIAL FIX' badge and appear before community suggestions"
    - "Community suggestions show disclaimer when no official response exists"
    - "Diagnostic report is generated after user approves bug report draft"
    - "Report is uploaded as .md file attachment to GitHub issue"
    - "Issue body contains quick summary with reference to attached report"
    - "If file upload fails, full report is embedded in issue body as fallback"
    - "User can review diagnostic report before submission"
  artifacts:
    - path: "midl-agent/src/search/workflow-orchestrator.ts"
      provides: "Badge formatting, diagnostic report workflow"
      contains: "OFFICIAL FIX"
    - path: "midl-agent/src/search/issue-creator.ts"
      provides: "Issue creation with diagnostic report attachment"
      contains: "diagnosticReport"
    - path: "midl-agent/src/search/github-client.ts"
      provides: "File upload to GitHub"
      contains: "uploadFileToRepo"
  key_links:
    - from: "midl-agent/src/search/workflow-orchestrator.ts"
      to: "midl-agent/src/search/diagnostic-report-generator.ts"
      via: "generates diagnostic report"
      pattern: "DiagnosticReportGenerator"
    - from: "midl-agent/src/search/workflow-orchestrator.ts"
      to: "midl-agent/src/search/issue-creator.ts"
      via: "submits report with diagnostic attachment"
      pattern: "submitReport.*diagnostic"
    - from: "midl-agent/src/search/issue-creator.ts"
      to: "midl-agent/src/search/github-client.ts"
      via: "uploads file attachment"
      pattern: "uploadFileToRepo"
---

<objective>
Wire official solution badges into the presentation layer and integrate diagnostic report generation into the bug report submission workflow.

Purpose: Users see clearly labeled official vs community solutions, and new bug reports include comprehensive diagnostic attachments for the MIDL team.
Output: Updated WorkflowOrchestrator with badge formatting and diagnostic workflow, IssueCreator with attachment support, GitHubClient with file upload.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-enhanced-solution-prioritization-and-detailed-bug-reports/02.2-01-SUMMARY.md
@.planning/phases/02.2-enhanced-solution-prioritization-and-detailed-bug-reports/02.2-02-SUMMARY.md
@midl-agent/src/search/workflow-orchestrator.ts
@midl-agent/src/search/issue-creator.ts
@midl-agent/src/search/github-client.ts
@midl-agent/src/search/diagnostic-report-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file upload to GitHubClient and attachment support to IssueCreator</name>
  <files>midl-agent/src/search/github-client.ts, midl-agent/src/search/issue-creator.ts</files>
  <action>
1. **GitHubClient** - add `uploadFileToRepo` method:
   ```typescript
   async uploadFileToRepo(
     path: string,
     content: string,
     message: string
   ): Promise<{ url: string } | null>
   ```
   - Use `this.octokit.rest.repos.createOrUpdateFileContents` with base64-encoded content
   - Path should be like `diagnostics/diagnostic-report-YYYY-MM-DDTHH-mm-ss.md`
   - Return `{ url: download_url }` on success
   - Return `null` on any error (graceful degradation) with console.warn

2. **IssueCreator** - update `createFromDraft` to accept optional diagnostic report:
   - Add parameter: `diagnosticReport?: { markdown: string; filename: string; summary: string }`
   - If diagnosticReport provided:
     a. First create the issue with body = summary text + "\n\n---\n\nSee attached diagnostic report for full details."
     b. Try to upload the .md file via `this.client.uploadFileToRepo`
     c. If upload succeeds, edit the issue body to include link to uploaded file
     d. If upload fails (returns null), edit the issue body to embed the full diagnostic markdown instead (fallback per CONTEXT.md)
   - If no diagnosticReport, behave exactly as before (backward compatible)

3. Use `this.octokit.rest.issues.update` in IssueCreator to update issue body after file upload attempt. Import is already available since IssueCreator has access to GitHubClient.
  </action>
  <verify>Run `cd midl-agent && npx tsc --noEmit` - compiles. Run `npx vitest run issue-creator` - existing tests still pass.</verify>
  <done>GitHubClient can upload files. IssueCreator creates issues with diagnostic report attachments, with fallback to embedded markdown.</done>
</task>

<task type="auto">
  <name>Task 2: Wire badge formatting and diagnostic workflow into WorkflowOrchestrator</name>
  <files>midl-agent/src/search/workflow-orchestrator.ts</files>
  <action>
1. **Update SolutionExtractor instantiation** - pass `this.githubClient` to SolutionExtractor constructor so it can check org membership:
   ```typescript
   this.solutionExtractor = deps?.solutionExtractor ?? new SolutionExtractor(this.githubClient);
   ```

2. **Update handleProblemReport** - since `solutionExtractor.extract` is now async, await it:
   ```typescript
   const extracted = await this.solutionExtractor.extract(result.issue, comments);
   ```

3. **Update formatSolutionsResponse** to use badge system per CONTEXT.md:
   - Separate solutions into official and community arrays
   - Official solutions first with "✓ OFFICIAL FIX" badge, regardless of score
   - Community solutions second
   - If only community solutions exist, prefix with: "No official MIDL team response found. Community suggestions (not officially verified by MIDL team):\n"
   - Within each group, sort by applicability score descending
   - For official solutions format: `**{i}. ✓ OFFICIAL FIX** ({pct}% match)`
   - For community solutions format: `**{i}. Community suggestion** ({pct}% match)`

4. **Add DiagnosticReportGenerator** to constructor deps:
   ```typescript
   private diagnosticReportGenerator: DiagnosticReportGenerator;
   ```
   Initialize in constructor with `deps?.diagnosticReportGenerator ?? new DiagnosticReportGenerator()`.

5. **Update submitReport** method to generate and attach diagnostic report:
   - Add optional `diagnosticContext?: DiagnosticContext` parameter
   - If diagnosticContext provided:
     a. Generate report via `this.diagnosticReportGenerator.generate(diagnosticContext)`
     b. Generate summary via `this.diagnosticReportGenerator.generateIssueSummary(diagnosticContext)`
     c. Pass `{ markdown: report.markdown, filename: report.filename, summary }` to `this.issueCreator.createFromDraft`
   - Update `formatReportDraftResponse` to mention diagnostic report: append "I'll also generate a comprehensive diagnostic report for the MIDL team." to the response.

6. **Add WorkflowResult fields** for diagnostic report:
   - Add `diagnosticReport?: { markdown: string; sizeBytes: number; sectionCount: number }` to WorkflowResult interface

7. **Update existing tests** in `workflow-orchestrator.test.ts`:
   - Mock SolutionExtractor.extract as async (returns Promise)
   - Verify badge formatting in output (check for "OFFICIAL FIX" when isOfficial is true)
   - Add test: official solutions appear before community solutions in formatted output
  </action>
  <verify>Run `cd midl-agent && npx tsc --noEmit` - compiles. Run `npx vitest run workflow-orchestrator` - all tests pass. Run `npx vitest run` - full suite passes.</verify>
  <done>WorkflowOrchestrator shows official badges, prioritizes official solutions, generates diagnostic reports on submission, and attaches them to GitHub issues with fallback.</done>
</task>

</tasks>

<verification>
1. `cd midl-agent && npx tsc --noEmit` passes
2. `cd midl-agent && npx vitest run` - full test suite passes
3. Official solutions show "✓ OFFICIAL FIX" badge in formatted output
4. Community-only results show disclaimer
5. Diagnostic report flow: generate -> preview offer -> upload/embed
</verification>

<success_criteria>
- Official solutions always appear before community suggestions
- Badge labels match CONTEXT.md exactly ("✓ OFFICIAL FIX", "Community suggestion (not officially verified by MIDL team)")
- Diagnostic reports generated on bug report submission
- File upload with graceful fallback to embedded markdown
- All tests pass including new badge and diagnostic scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-enhanced-solution-prioritization-and-detailed-bug-reports/02.2-03-SUMMARY.md`
</output>
