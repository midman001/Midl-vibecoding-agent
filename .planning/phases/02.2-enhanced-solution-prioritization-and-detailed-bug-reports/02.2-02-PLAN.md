---
phase: 02.2-enhanced-solution-prioritization-and-detailed-bug-reports
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - midl-agent/src/search/diagnostic-report-generator.ts
autonomous: true

must_haves:
  truths:
    - "DiagnosticReportGenerator produces a markdown report with all 5 required sections"
    - "Environment section includes comprehensive package/version details"
    - "Report includes agent search steps, fixes attempted, and structured suggestions"
    - "Generated markdown is valid GitHub-flavored markdown"
  artifacts:
    - path: "midl-agent/src/search/diagnostic-report-generator.ts"
      provides: "Diagnostic report generation"
      exports: ["DiagnosticReportGenerator", "DiagnosticReport", "DiagnosticContext"]
  key_links:
    - from: "midl-agent/src/search/diagnostic-report-generator.ts"
      to: "midl-agent/src/types/search-types.ts"
      via: "imports DuplicateDetectionResult, ApplicabilityResult"
      pattern: "import.*search-types"
---

<objective>
Create the DiagnosticReportGenerator class that produces comprehensive .md diagnostic reports.

Purpose: When users file new bug reports, the agent generates a detailed diagnostic report with environment info, search steps, fixes attempted, and suggestions for the MIDL team.
Output: New diagnostic-report-generator.ts with DiagnosticReportGenerator class and supporting types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@midl-agent/src/types/search-types.ts
@midl-agent/src/search/bug-report-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiagnosticReportGenerator class</name>
  <files>midl-agent/src/search/diagnostic-report-generator.ts</files>
  <action>
Create new file `midl-agent/src/search/diagnostic-report-generator.ts` with:

1. **DiagnosticContext interface** - input data the generator needs:
   ```typescript
   export interface DiagnosticContext {
     userDescription: string;
     errorMessages: string[];
     environment: {
       sdkPackages?: Record<string, string>; // e.g. {"@midl/react": "2.1.0"}
       nodeVersion?: string;
       os?: string;
       browser?: string;
       walletVersion?: string;
       network?: string;
       relevantDependencies?: Record<string, string>;
     };
     searchSteps: {
       searchTerms: string[];
       resultsCount: number;
       duplicatesFound: number;
       similarityScores: { issueNumber: number; score: number }[];
     };
     fixesAttempted: {
       description: string;
       outcome: "success" | "failed" | "partial";
       reason?: string;
     }[];
     suggestions: {
       possibleCauses: string[];
       recommendedFixes: string[];
       testCases: string[];
     };
   }
   ```

2. **DiagnosticReport interface** - output:
   ```typescript
   export interface DiagnosticReport {
     markdown: string;
     sizeBytes: number;
     sectionCount: number;
     filename: string; // e.g. "diagnostic-report-2026-02-01T12-00-00.md"
   }
   ```

3. **DiagnosticReportGenerator class** with:
   - `generate(context: DiagnosticContext): DiagnosticReport` method
   - Produces GitHub-flavored markdown with 5 sections per CONTEXT.md:

   **Section 1: Problem Description**
   - User's description verbatim
   - Error messages in code blocks
   - Expected vs actual (if extractable)

   **Section 2: Environment Details**
   - All SDK packages with versions in a table
   - Node.js version, OS, browser, wallet
   - Network (testnet/mainnet/etc)
   - Relevant dependencies in a table
   - If any field is missing, show "Not detected" (don't omit the row)

   **Section 3: Steps Taken by Agent**
   - Search terms used
   - Number of results and duplicates found
   - Top similarity scores in a table (issue #, score %)

   **Section 4: Fixes Attempted**
   - Each fix with outcome badge: success/failed/partial
   - If no fixes attempted, show "No automated fixes were attempted."

   **Section 5: Suggestions for Team**
   - **Possible Causes:** bulleted list
   - **Recommended Fixes:** bulleted list
   - **Test Cases:** bulleted list
   - If any sub-section empty, show "None identified."

   - `generateFilename(): string` helper that returns `diagnostic-report-YYYY-MM-DDTHH-mm-ss.md`
   - `generateIssueSummary(context: DiagnosticContext): string` method that returns a 3-4 sentence summary for the issue body (brief problem, what was tried, outcome)

4. Keep the class stateless - pure function on input data. No dependencies beyond types.

5. Truncate error messages longer than 500 chars with "... (truncated)" suffix.
  </action>
  <verify>Run `cd midl-agent && npx tsc --noEmit` - compiles. Manually verify file exists and has all 5 sections in generate method.</verify>
  <done>DiagnosticReportGenerator exists, produces complete 5-section markdown reports, generates filenames and issue summaries. Stateless, no external dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for DiagnosticReportGenerator</name>
  <files>midl-agent/src/search/diagnostic-report-generator.test.ts</files>
  <action>
Create test file with vitest. Test cases:

1. **Full context generates all 5 sections** - provide complete DiagnosticContext, verify markdown contains all section headings ("## Problem Description", "## Environment Details", "## Steps Taken by Agent", "## Fixes Attempted", "## Suggestions for Team")

2. **Missing environment fields show "Not detected"** - provide context with empty environment, verify "Not detected" appears

3. **No fixes attempted shows appropriate message** - empty fixesAttempted array, verify "No automated fixes were attempted."

4. **Error messages are truncated** - provide error message >500 chars, verify "... (truncated)" suffix

5. **generateIssueSummary returns brief text** - verify output is under 500 chars

6. **generateFilename returns valid format** - verify matches pattern `diagnostic-report-\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}.md`

7. **sizeBytes and sectionCount are accurate** - verify sectionCount is 5, sizeBytes matches Buffer.byteLength of markdown
  </action>
  <verify>Run `cd midl-agent && npx vitest run diagnostic-report-generator` - all tests pass.</verify>
  <done>DiagnosticReportGenerator has comprehensive unit tests covering all sections, edge cases, and output format.</done>
</task>

</tasks>

<verification>
1. `cd midl-agent && npx tsc --noEmit` passes
2. `cd midl-agent && npx vitest run diagnostic-report-generator` passes
3. Generated markdown has all 5 sections with correct headings
</verification>

<success_criteria>
- DiagnosticReportGenerator produces valid 5-section markdown reports
- All edge cases handled (missing data, long errors, empty fixes)
- Issue summary is concise (3-4 sentences)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-enhanced-solution-prioritization-and-detailed-bug-reports/02.2-02-SUMMARY.md`
</output>
